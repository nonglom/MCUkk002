<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบริหารงานสำนักวิชาการ วิทยาเขตขอนแก่น</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- DataTables CSS and JS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    
    <!-- Firebase SDK v11+ -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
        import { getDatabase, ref, set, get, push, remove, onValue } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCj5PZcD7jHN2uJNxTUQTi8x7LOcS9DoPU",
            authDomain: "mcukk009.firebaseapp.com",
            databaseURL: "https://mcukk009-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mcukk009",
            storageBucket: "mcukk009.firebasestorage.app",
            messagingSenderId: "22972142767",
            appId: "1:22972142767:web:a6e8250905bef7f0acb05a"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Make Firebase functions available globally
        window.firebaseDB = {
            database,
            ref,
            set,
            get,
            push,
            remove,
            onValue
        };

        // Initialize app after Firebase is ready
        window.addEventListener('load', () => {
            if (window.initApp) {
                window.initApp();
            }
        });
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .sidebar-collapsed { width: 80px; }
        .sidebar-expanded { width: 280px; }
        .content-collapsed { margin-left: 80px; }
        .content-expanded { margin-left: 280px; }
        .gantt-bar { height: 20px; border-radius: 10px; position: relative; }
        .gantt-complete { background: linear-gradient(90deg, #10b981, #059669); }
        .gantt-progress { background: linear-gradient(90deg, #ec4899, #db2777); }
        .gantt-delayed { background: linear-gradient(90deg, #f59e0b, #d97706); }
        .gantt-notstarted { background: linear-gradient(90deg, #f43f5e, #e11d48); }
        .priority-urgent { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .priority-important { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .priority-normal { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .priority-low { background: linear-gradient(135deg, #6b7280, #4b5563); }
        .modal { display: none; }
        .modal.active { display: flex; }
        .dropdown-item:hover { background-color: #f3f4f6; }
        
        /* DataTable Custom Styles */
        .dataTables_wrapper {
            font-family: 'Sarabun', sans-serif;
        }
        table.dataTable thead th {
            background: linear-gradient(135deg, #ec4899, #db2777);
            color: white;
            border-bottom: none;
        }
        table.dataTable tbody tr:hover {
            background-color: #fdf2f8;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Login Modal -->
    <div id="loginModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold text-center mb-6 text-pink-600">เข้าสู่ระบบผู้ดูแล</h2>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">รหัสผ่าน</label>
                <input type="password" id="adminPassword" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" placeholder="กรุณาใส่รหัสผ่าน">
            </div>
            <div class="flex gap-4">
                <button onclick="login()" class="flex-1 bg-pink-500 text-white py-2 px-4 rounded-lg hover:bg-pink-600 shadow-md hover:shadow-lg transition-all">เข้าสู่ระบบ</button>
                <button onclick="closeLogin()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400">ยกเลิก</button>
            </div>
        </div>
    </div>

    <!-- Task Assignment Modal -->
    <div id="taskModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-pink-600">มอบหมายงานใหม่</h2>
                <button onclick="closeTaskModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="taskForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- อัปโหลดรูปบุคลากร -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">อัปโหลดรูปบุคลากร (ไม่บังคับ)</label>
                    <div class="relative">
                        <input type="file" id="personImage" class="hidden" accept="image/*,image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/webp,image/svg+xml" onchange="handleImageSelect()">
                        <div id="imageDropZone" class="w-full border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-colors" onclick="document.getElementById('personImage').click()">
                            <div id="dropZoneContent">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                                <p class="text-gray-600 mb-1">คลิกเพื่อเลือกรูปภาพ หรือลากไฟล์มาวางที่นี่</p>
                                <p class="text-sm text-gray-500">รองรับไฟล์: JPG, PNG, GIF, BMP, WebP, SVG</p>
                                <p class="text-xs text-gray-400 mt-1">ขนาดไฟล์สูงสุด: 5MB</p>
                            </div>
                        </div>
                    </div>
                    <div id="imagePreview" class="mt-3"></div>
                </div>

                <!-- ชื่องาน -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">ชื่องาน</label>
                    <input type="text" id="taskName" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" placeholder="กรุณาใส่ชื่องาน">
                </div>

                <!-- ผู้รับผิดชอบ -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">ผู้รับผิดชอบ</label>
                    <select id="responsible" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" onchange="autoFillPersonData()">
                        <option value="">เลือกผู้รับผิดชอบ</option>
                        <option value="0">พระครูศรีพุทธิบัณฑิต, ผศ.ดร.</option>
                        <option value="1">นายนิรุต ป้องสีดา</option>
                        <option value="2">นางรพีพร มณีวรรณ</option>
                        <option value="3">นางสาวธิดารัตน์ วรจักร</option>
                        <option value="4">นายนิรันดร เลิศวีรพล</option>
                        <option value="5">นางอมรินทร์ แก้วทาสี</option>
                        <option value="6">นางสาวอรุณ แสนใจวุฒิ</option>
                        <option value="7">นายอภิวัฒน์ สาระบัน</option>
                        <option value="8">นางฤดี แสงเดือนฉาย</option>
                        <option value="9">นางสาวสาริกา ไสวงาม</option>
                        <option value="10">นางสาวมาริสา ไสวงาม</option>
                        <option value="11">นายสุนทร เสนาซุย</option>
                        <option value="12">นายธนรัฐ อดทน</option>
                        <option value="13">นางสาวรุ่งนภา โยนดัน</option>
                        <option value="other">อื่นๆโปรดระบุ</option>
                    </select>
                    <input type="text" id="customResponsible" class="hidden mt-2 w-full px-3 py-2 border rounded-lg" placeholder="กรุณาระบุชื่อ">
                </div>

                <!-- ตำแหน่ง -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">ตำแหน่ง</label>
                    <select id="position" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" onchange="handlePositionSelect()">
                        <option value="">เลือกตำแหน่ง</option>
                        <option value="ผู้อำนวยการสำนักวิชาการวิทยาเขตขอนแก่น">ผู้อำนวยการสำนักวิชาการวิทยาเขตขอนแก่น</option>
                        <option value="ผู้อำนวยการส่วนสนับสนุนวิชาการ">ผู้อำนวยการส่วนสนับสนุนวิชาการ</option>
                        <option value="นักจัดการงานทั่วไป ชำนาญการ">นักจัดการงานทั่วไป ชำนาญการ</option>
                        <option value="เจ้าหน้าที่ทะเบียน">เจ้าหน้าที่ทะเบียน</option>
                        <option value="นักวิชาการคอมพิวเตอร์ ชำนาญการ">นักวิชาการคอมพิวเตอร์ ชำนาญการ</option>
                        <option value="นักจัดการงานทั่วไป">นักจัดการงานทั่วไป</option>
                        <option value="บรรณารักษ์">บรรณารักษ์</option>
                        <option value="นักประชาสัมพันธ์">นักประชาสัมพันธ์</option>
                        <option value="นักวิชาการศึกษา ชำนาญการ">นักวิชาการศึกษา ชำนาญการ</option>
                        <option value="นักวิชาการศึกษา">นักวิชาการศึกษา</option>
                        <option value="other">อื่นๆโปรดระบุ</option>
                    </select>
                    <input type="text" id="customPosition" class="hidden mt-2 w-full px-3 py-2 border rounded-lg" placeholder="กรุณาระบุตำแหน่ง">
                </div>

                <!-- รายละเอียดงาน -->
                <div class="md:col-span-2">
                    <label class="block text-gray-700 font-semibold mb-2">รายละเอียดงาน</label>
                    <textarea id="taskDetail" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500 h-24" placeholder="กรุณาใส่รายละเอียดงาน"></textarea>
                </div>

                <!-- กลุ่มงาน -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">กลุ่มงาน</label>
                    <select id="workGroup" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" onchange="handleWorkGroupSelect()">
                        <option value="">เลือกกลุ่มงาน</option>
                        <option value="กลุ่มงานสำนักวิชาการวิทยาเขตขอนแก่น">กลุ่มงานสำนักวิชาการวิทยาเขตขอนแก่น</option>
                        <option value="กลุ่มงานส่วนสนับสนุนวิชาการ">กลุ่มงานส่วนสนับสนุนวิชาการ</option>
                        <option value="กลุ่มงานงานทะเบียน">กลุ่มงานงานทะเบียน</option>
                        <option value="กลุ่มงานประกันคุณภาพและวิจัย">กลุ่มงานประกันคุณภาพและวิจัย</option>
                        <option value="กลุ่มงานห้องสมุดสารทนเทศ">กลุ่มงานห้องสมุดสารทนเทศ</option>
                        <option value="กลุ่มงานส่งเสริมฯ">กลุ่มงานส่งเสริมฯ</option>
                        <option value="other">อื่นๆโปรดระบุ</option>
                    </select>
                    <input type="text" id="customWorkGroup" class="hidden mt-2 w-full px-3 py-2 border rounded-lg" placeholder="กรุณาระบุกลุ่มงาน">
                </div>

                <!-- ระดับความสำคัญ -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">ระดับความสำคัญ</label>
                    <select id="priority" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                        <option value="">เลือกระดับความสำคัญ</option>
                        <option value="สำคัญและเร่งด่วน">สำคัญและเร่งด่วน</option>
                        <option value="สำคัญแต่ไม่เร่งด่วน">สำคัญแต่ไม่เร่งด่วน</option>
                        <option value="ไม่สำคัญแต่เร่งด่วน">ไม่สำคัญแต่เร่งด่วน</option>
                        <option value="ไม่สำคัญและไม่เร่งด่วน">ไม่สำคัญและไม่เร่งด่วน</option>
                    </select>
                </div>

                <!-- สถานะปัจจุบัน -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">สถานะปัจจุบัน</label>
                    <select id="status" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                        <option value="">เลือกสถานะ</option>
                        <option value="ยังไม่เริ่ม">ยังไม่เริ่ม</option>
                        <option value="กำลังดำเนินการ">กำลังดำเนินการ</option>
                        <option value="ติดปัญหา/ล่าช้า">ติดปัญหา/ล่าช้า</option>
                        <option value="เสร็จสมบูรณ์">เสร็จสมบูรณ์</option>
                    </select>
                </div>

                <!-- วันเริ่มต้น -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">วันเริ่มต้น</label>
                    <input type="date" id="startDate" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                </div>

                <!-- วันสิ้นสุด -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">วันสิ้นสุด</label>
                    <input type="date" id="endDate" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                </div>

                <!-- แนบไฟล์ -->
                <div class="md:col-span-2">
                    <label class="block text-gray-700 font-semibold mb-2">แนบไฟล์ (ไม่บังคับ)</label>
                    <input type="file" id="attachFile" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" multiple>
                </div>

                <!-- ปุ่มบันทึก -->
                <div class="md:col-span-2 flex gap-4 pt-4">
                    <button type="button" onclick="saveTask()" class="flex-1 bg-pink-500 text-white py-3 px-6 rounded-lg hover:bg-pink-600 font-semibold shadow-md hover:shadow-lg transition-all">
                        <i class="fas fa-save mr-2"></i>บันทึกงาน
                    </button>
                    <button type="button" onclick="closeTaskModal()" class="flex-1 bg-gray-300 text-gray-700 py-3 px-6 rounded-lg hover:bg-gray-400 font-semibold">
                        <i class="fas fa-times mr-2"></i>ยกเลิก
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Sidebar -->
    <div id="sidebar" class="sidebar-expanded fixed left-0 top-0 h-full bg-gradient-to-b from-pink-500 to-pink-600 text-white transition-all duration-300 z-40">
        <div class="p-4">
            <div class="flex items-center justify-between mb-8">
                <div id="sidebarTitle" class="text-lg font-bold">ระบบบริหารงาน</div>
                <button onclick="toggleSidebar()" class="text-white hover:text-blue-200 transition-colors">
                    <i id="toggleIcon" class="fas fa-chevron-left text-lg"></i>
                </button>
            </div>
            
            <nav class="space-y-2">
                <a href="#" onclick="showPage('dashboard', event); return false;" class="nav-item flex items-center p-3 rounded-lg hover:bg-pink-400 transition-colors bg-pink-400" id="dashboardNav">
                    <i class="fas fa-tachometer-alt w-6"></i>
                    <span class="nav-text ml-3">แดชบอร์ด</span>
                </a>
                <a href="#" onclick="showPage('tasks', event); return false;" class="nav-item flex items-center p-3 rounded-lg hover:bg-pink-400 transition-colors" id="tasksNav">
                    <i class="fas fa-tasks w-6"></i>
                    <span class="nav-text ml-3">มอบหมายงาน</span>
                </a>
                <a href="#" onclick="showPage('gantt', event); return false;" class="nav-item flex items-center p-3 rounded-lg hover:bg-pink-400 transition-colors" id="ganttNav">
                    <i class="fas fa-chart-gantt w-6"></i>
                    <span class="nav-text ml-3">แผนปฏิบัติการ</span>
                </a>
                <a href="#" onclick="showPage('reports', event); return false;" class="nav-item flex items-center p-3 rounded-lg hover:bg-pink-400 transition-colors" id="reportsNav">
                    <i class="fas fa-chart-bar w-6"></i>
                    <span class="nav-text ml-3">สรุปผลงานรายบุคคล</span>
                </a>
                <a href="#" onclick="showLogin(); return false;" class="nav-item flex items-center p-3 rounded-lg hover:bg-pink-400 transition-colors" id="adminLoginBtn">
                    <i class="fas fa-user-shield w-6"></i>
                    <span class="nav-text ml-3">ผู้ดูแลระบบ</span>
                </a>
                <a href="#" onclick="logout(); return false;" class="nav-item flex items-center p-3 rounded-lg hover:bg-pink-400 transition-colors hidden" id="adminLogoutBtn">
                    <i class="fas fa-sign-out-alt w-6"></i>
                    <span class="nav-text ml-3">ออกจากระบบ</span>
                </a>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="content-expanded transition-all duration-300 min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b p-4">
            <div class="flex items-center justify-between">
                <h1 id="pageTitle" class="text-2xl font-bold text-gray-800">แดชบอร์ด</h1>
                <div class="text-sm text-gray-600">
                    <i class="fas fa-calendar-alt mr-2"></i>
                    <span id="currentDate"></span>
                </div>
            </div>
        </header>

        <!-- Dashboard Page -->
        <div id="dashboardPage" class="page p-6">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-gradient-to-r from-pink-500 to-pink-600 rounded-lg p-6 text-white shadow-lg hover:shadow-xl transition-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-pink-100">งานทั้งหมด</p>
                            <p class="text-3xl font-bold" id="totalTasks">0</p>
                        </div>
                        <i class="fas fa-tasks text-4xl text-pink-200"></i>
                    </div>
                </div>
                <div class="bg-gradient-to-r from-emerald-500 to-emerald-600 rounded-lg p-6 text-white shadow-lg hover:shadow-xl transition-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-emerald-100">เสร็จสมบูรณ์</p>
                            <p class="text-3xl font-bold" id="completedTasks">0</p>
                        </div>
                        <i class="fas fa-check-circle text-4xl text-emerald-200"></i>
                    </div>
                </div>
                <div class="bg-gradient-to-r from-amber-500 to-amber-600 rounded-lg p-6 text-white shadow-lg hover:shadow-xl transition-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-amber-100">กำลังดำเนินการ</p>
                            <p class="text-3xl font-bold" id="inProgressTasks">0</p>
                        </div>
                        <i class="fas fa-clock text-4xl text-amber-200"></i>
                    </div>
                </div>
                <div class="bg-gradient-to-r from-rose-500 to-rose-600 rounded-lg p-6 text-white shadow-lg hover:shadow-xl transition-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-rose-100">ล่าช้า</p>
                            <p class="text-3xl font-bold" id="delayedTasks">0</p>
                        </div>
                        <i class="fas fa-exclamation-triangle text-4xl text-rose-200"></i>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4 text-pink-600">สถานะงาน</h3>
                    <div class="h-64 flex items-center justify-center">
                        <canvas id="statusChart" width="300" height="300"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4 text-pink-600">งานตามกลุ่ม</h3>
                    <div class="h-64 flex items-center justify-center">
                        <canvas id="groupChart" width="300" height="300"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4 text-pink-600">ระดับความสำคัญ</h3>
                    <div class="h-64 flex items-center justify-center">
                        <canvas id="priorityChart" width="300" height="300"></canvas>
                    </div>
                </div>
            </div>

            <!-- Additional Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4 text-pink-600">งานรายเดือน</h3>
                    <div class="h-64 flex items-center justify-center">
                        <canvas id="monthlyChart" width="400" height="200"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4 text-pink-600">ประสิทธิภาพการทำงาน</h3>
                    <div class="h-64 flex items-center justify-center">
                        <canvas id="performanceChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- Workload Analysis -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h3 class="text-lg font-semibold mb-4 text-pink-600">การกระจายภาระงานรายบุคคล</h3>
                <div class="h-80 flex items-center justify-center">
                    <canvas id="workloadChart" width="800" height="400"></canvas>
                </div>
            </div>

            <!-- Staff Table -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4 text-pink-600">สรุปงานรายบุคคล</h3>
                <div class="overflow-x-auto">
                    <table id="staffTable" class="display" style="width:100%">
                        <thead>
                            <tr>
                                <th>รูปบุคลากร</th>
                                <th>ผู้รับผิดชอบ</th>
                                <th>ตำแหน่ง</th>
                                <th>กลุ่มงาน</th>
                                <th>งานทั้งหมด</th>
                                <th>กำลังดำเนินการ</th>
                                <th>เสร็จสมบูรณ์</th>
                                <th>ล่าช้า</th>
                            </tr>
                        </thead>
                        <tbody id="staffTableBody">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tasks Page -->
        <div id="tasksPage" class="page p-6 hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-pink-600">จัดการงาน</h2>
                <button onclick="openTaskModal()" class="bg-pink-500 text-white px-6 py-2 rounded-lg hover:bg-pink-600 flex items-center shadow-md hover:shadow-lg transition-all">
                    <i class="fas fa-plus mr-2"></i>มอบหมายงานใหม่
                </button>
            </div>

            <!-- Pending Tasks -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4 text-pink-600">งานที่ต้องจัดการ</h3>
                <div class="overflow-x-auto">
                    <table id="pendingTasksTable" class="display" style="width:100%">
                        <thead>
                            <tr>
                                <th>รูปบุคลากร</th>
                                <th>ชื่องาน</th>
                                <th>ผู้รับผิดชอบ</th>
                                <th>ตำแหน่ง</th>
                                <th>กลุ่มงาน</th>
                                <th>ระดับความสำคัญ</th>
                                <th>สถานะ</th>
                                <th>วันเริ่มต้น</th>
                                <th>วันสิ้นสุด</th>
                                <th>วันคงเหลือ</th>
                                <th class="admin-column" style="display: none;">การจัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="pendingTasksBody">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Completed Tasks -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4 text-pink-600">งานที่เสร็จสิ้น</h3>
                <div class="overflow-x-auto">
                    <table id="completedTasksTable" class="display" style="width:100%">
                        <thead>
                            <tr>
                                <th>รูปบุคลากร</th>
                                <th>ชื่องาน</th>
                                <th>ผู้รับผิดชอบ</th>
                                <th>ตำแหน่ง</th>
                                <th>กลุ่มงาน</th>
                                <th>วันที่เสร็จ</th>
                                <th>ระยะเวลาที่ใช้</th>
                                <th class="completed-admin-column" style="display: none;">การจัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="completedTasksBody">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Gantt Chart Page -->
        <div id="ganttPage" class="page p-6 hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-pink-600">แผนปฏิบัติการ (Gantt Chart)</h2>
                    <div class="flex gap-4">
                        <select id="statusFilter" class="px-3 py-2 border border-pink-300 rounded-lg focus:border-pink-500" onchange="filterGantt()">
                            <option value="">ทุกสถานะ</option>
                            <option value="ยังไม่เริ่ม">ยังไม่เริ่ม</option>
                            <option value="กำลังดำเนินการ">กำลังดำเนินการ</option>
                            <option value="ติดปัญหา/ล่าช้า">ติดปัญหา/ล่าช้า</option>
                            <option value="เสร็จสมบูรณ์">เสร็จสมบูรณ์</option>
                        </select>
                        <select id="responsibleFilter" class="px-3 py-2 border border-pink-300 rounded-lg focus:border-pink-500" onchange="filterGantt()">
                            <option value="">ทุกคน</option>
                        </select>
                        <select id="yearFilter" class="px-3 py-2 border border-pink-300 rounded-lg focus:border-pink-500" onchange="filterGantt()">
                            <option value="">ทุกปี</option>
                            <option value="2567">2567</option>
                            <option value="2568">2568</option>
                            <option value="2569">2569</option>
                        </select>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <div class="min-w-[1400px]">
                        <!-- Gantt Header -->
                        <div class="grid grid-cols-16 gap-2 mb-4">
                            <div class="col-span-4 bg-pink-100 p-3 font-semibold text-pink-800">รายละเอียดงาน</div>
                            <div class="col-span-12 grid grid-cols-12 gap-2">
                                <div class="bg-pink-50 p-3 text-center font-semibold text-pink-700 border border-pink-200">ม.ค.</div>
                                <div class="bg-pink-50 p-3 text-center font-semibold text-pink-700 border border-pink-200">ก.พ.</div>
                                <div class="bg-pink-50 p-3 text-center font-semibold text-pink-700 border border-pink-200">มี.ค.</div>
                                <div class="bg-pink-50 p-3 text-center font-semibold text-pink-700 border border-pink-200">เม.ย.</div>
                                <div class="bg-pink-50 p-3 text-center font-semibold text-pink-700 border border-pink-200">พ.ค.</div>
                                <div class="bg-pink-50 p-3 text-center font-semibold text-pink-700 border border-pink-200">มิ.ย.</div>
                                <div class="bg-pink-50 p-3 text-center font-semibold text-pink-700 border border-pink-200">ก.ค.</div>
                                <div class="bg-pink-50 p-3 text-center font-semibold text-pink-700 border border-pink-200">ส.ค.</div>
                                <div class="bg-pink-50 p-3 text-center font-semibold text-pink-700 border border-pink-200">ก.ย.</div>
                                <div class="bg-pink-50 p-3 text-center font-semibold text-pink-700 border border-pink-200">ต.ค.</div>
                                <div class="bg-pink-50 p-3 text-center font-semibold text-pink-700 border border-pink-200">พ.ย.</div>
                                <div class="bg-pink-50 p-3 text-center font-semibold text-pink-700 border border-pink-200">ธ.ค.</div>
                            </div>
                        </div>

                        <!-- Gantt Body -->
                        <div id="ganttBody">
                            <!-- Data will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Page -->
        <div id="reportsPage" class="page p-6 hidden">
            <div class="mb-6">
                <h2 class="text-xl font-semibold mb-4 text-pink-600">สรุปผลงานรายบุคคล</h2>
                
                <!-- Filters -->
                <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">ผู้รับผิดชอบ</label>
                            <select id="reportPersonFilter" class="w-full px-3 py-2 border rounded-lg" onchange="filterReports()">
                                <option value="">ทุกคน</option>
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">กลุ่มงาน</label>
                            <select id="reportGroupFilter" class="w-full px-3 py-2 border rounded-lg" onchange="filterReports()">
                                <option value="">ทุกกลุ่ม</option>
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="printReport()" class="bg-pink-500 text-white px-6 py-2 rounded-lg hover:bg-pink-600 flex items-center shadow-md hover:shadow-lg transition-all">
                                <i class="fas fa-print mr-2"></i>พิมพ์รายงาน
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Person Cards -->
                <div id="personCards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                    <!-- Cards will be populated by JavaScript -->
                </div>

                <!-- Report Tables -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold mb-4">งานที่ต้องจัดการ</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full table-auto">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="px-4 py-3 text-left">ชื่องาน</th>
                                        <th class="px-4 py-3 text-left">ผู้รับผิดชอบ</th>
                                        <th class="px-4 py-3 text-left">สถานะ</th>
                                        <th class="px-4 py-3 text-left">วันสิ้นสุด</th>
                                    </tr>
                                </thead>
                                <tbody id="reportPendingBody">
                                    <!-- Data will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold mb-4">งานที่เสร็จสิ้น</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full table-auto">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="px-4 py-3 text-left">ชื่องาน</th>
                                        <th class="px-4 py-3 text-left">ผู้รับผิดชอบ</th>
                                        <th class="px-4 py-3 text-left">วันที่เสร็จ</th>
                                        <th class="px-4 py-3 text-left">ระยะเวลา</th>
                                    </tr>
                                </thead>
                                <tbody id="reportCompletedBody">
                                    <!-- Data will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let sidebarCollapsed = false;
        let isAdmin = false;
        let tasks = [];
        let currentPage = 'dashboard';
        let firebaseInitialized = false;
        let editingTaskId = null;
        let statusChart = null;
        let groupChart = null;
        let priorityChart = null;
        let monthlyChart = null;
        let performanceChart = null;
        let workloadChart = null;
        
        // DataTable instances
        let staffDataTable = null;
        let pendingTasksDataTable = null;
        let completedTasksDataTable = null;

        // Get unique staff data from tasks
        function getUniqueStaffData() {
            const uniqueStaff = [];
            const seenNames = new Set();
            
            tasks.forEach(task => {
                if (task.responsible && !seenNames.has(task.responsible)) {
                    seenNames.add(task.responsible);
                    uniqueStaff.push({
                        name: task.responsible,
                        image: task.image || '',
                        position: task.position || '',
                        workGroup: task.workGroup || ''
                    });
                }
            });
            
            return uniqueStaff;
        }

        // Initialize the application
        window.initApp = function() {
            firebaseInitialized = true;
            updateCurrentDate();
            
            // Load from localStorage first for immediate display
            loadFromLocalStorage();
            
            // Then try to load from Firebase
            loadTasksFromFirebase();
            setupRealtimeListener();
            showPage('dashboard');
            populateFilters();
            
            // Set default date for new tasks
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            document.getElementById('endDate').value = nextWeek.toISOString().split('T')[0];
        }

        // Load from localStorage
        function loadFromLocalStorage() {
            try {
                const savedTasks = localStorage.getItem('tasks');
                if (savedTasks) {
                    const parsedTasks = JSON.parse(savedTasks);
                    if (Array.isArray(parsedTasks)) {
                        tasks = parsedTasks;
                    } else {
                        console.warn('Invalid tasks data in localStorage, resetting');
                        tasks = [];
                        localStorage.setItem('tasks', JSON.stringify(tasks));
                    }
                } else {
                    tasks = [];
                }
                
                // Update views after loading
                updateDashboard();
                updateTasksPage();
                updateGanttChart();
                updateReportsPage();
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                tasks = [];
                // Clear corrupted data
                try {
                    localStorage.removeItem('tasks');
                    localStorage.setItem('tasks', JSON.stringify(tasks));
                } catch (clearError) {
                    console.error('Error clearing localStorage:', clearError);
                }
            }
        }

        // Update current date
        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('th-TH', options);
        }

        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const toggleIcon = document.getElementById('toggleIcon');
            const sidebarTitle = document.getElementById('sidebarTitle');
            const navTexts = document.querySelectorAll('.nav-text');

            sidebarCollapsed = !sidebarCollapsed;

            if (sidebarCollapsed) {
                sidebar.classList.remove('sidebar-expanded');
                sidebar.classList.add('sidebar-collapsed');
                mainContent.classList.remove('content-expanded');
                mainContent.classList.add('content-collapsed');
                toggleIcon.classList.remove('fa-chevron-left');
                toggleIcon.classList.add('fa-chevron-right');
                sidebarTitle.style.display = 'none';
                navTexts.forEach(text => text.style.display = 'none');
            } else {
                sidebar.classList.remove('sidebar-collapsed');
                sidebar.classList.add('sidebar-expanded');
                mainContent.classList.remove('content-collapsed');
                mainContent.classList.add('content-expanded');
                toggleIcon.classList.remove('fa-chevron-right');
                toggleIcon.classList.add('fa-chevron-left');
                sidebarTitle.style.display = 'block';
                navTexts.forEach(text => text.style.display = 'inline');
            }
        }

        // Show page
        function showPage(page, event) {
            console.log('Showing page:', page);
            
            try {
                // Hide all pages
                document.querySelectorAll('.page').forEach(p => {
                    p.classList.add('hidden');
                });
                
                // Remove active class from all nav items
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('bg-blue-700');
                });

                // Show selected page
                const pageElement = document.getElementById(page + 'Page');
                if (pageElement) {
                    pageElement.classList.remove('hidden');
                    console.log('Page element found and shown:', page + 'Page');
                } else {
                    console.error('Page element not found:', page + 'Page');
                    return;
                }
                
                // Update page title
                const titles = {
                    'dashboard': 'แดชบอร์ด',
                    'tasks': 'มอบหมายงาน',
                    'gantt': 'แผนปฏิบัติการ',
                    'reports': 'สรุปผลงานรายบุคคล'
                };
                
                const titleElement = document.getElementById('pageTitle');
                if (titleElement && titles[page]) {
                    titleElement.textContent = titles[page];
                }

                // Add active class to current nav item
                if (event && event.target) {
                    const navItem = event.target.closest('.nav-item');
                    if (navItem) {
                        navItem.classList.add('bg-pink-400');
                    }
                } else {
                    // Fallback: find nav item by page name
                    const navItems = document.querySelectorAll('.nav-item');
                    navItems.forEach(item => {
                        const onclick = item.getAttribute('onclick');
                        if (onclick && onclick.includes(`'${page}'`)) {
                            item.classList.add('bg-pink-400');
                        }
                    });
                }

                // Update current page
                currentPage = page;

                // Update page-specific content immediately and with delay for safety
                updatePageContent(page);
                setTimeout(() => updatePageContent(page), 100);
                
            } catch (error) {
                console.error('Error in showPage:', error);
                
                // Fallback to dashboard
                if (page !== 'dashboard') {
                    showPage('dashboard');
                }
            }
        }

        // Helper function to update page content
        function updatePageContent(page) {
            try {
                switch (page) {
                    case 'dashboard':
                        updateDashboard();
                        break;
                    case 'tasks':
                        updateTasksPage();
                        break;
                    case 'gantt':
                        updateGanttChart();
                        break;
                    case 'reports':
                        updateReportsPage();
                        break;
                    default:
                        console.warn('Unknown page:', page);
                }
            } catch (error) {
                console.error('Error updating page content for', page, ':', error);
            }
        }

        // Login functions
        function showLogin() {
            document.getElementById('loginModal').classList.add('active');
        }

        function closeLogin() {
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('adminPassword').value = '';
        }

        async function login() {
            const password = document.getElementById('adminPassword').value;
            if (password === '12345') {
                isAdmin = true;
                closeLogin();
                
                // Update UI for admin
                document.getElementById('adminLoginBtn').classList.add('hidden');
                document.getElementById('adminLogoutBtn').classList.remove('hidden');
                
                // Show quick success message
                Swal.fire({
                    icon: 'success',
                    title: 'เข้าสู่ระบบสำเร็จ!',
                    timer: 1000,
                    showConfirmButton: false,
                    toast: true,
                    position: 'top-end'
                });

                updateTasksPage(); // Refresh tasks page to show admin controls
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'รหัสผ่านไม่ถูกต้อง',
                    text: 'กรุณาตรวจสอบรหัสผ่านและลองใหม่อีกครั้ง',
                    confirmButtonText: 'ตกลง'
                });
            }
        }

        // Logout function
        function logout() {
            Swal.fire({
                title: 'ออกจากระบบ?',
                text: 'คุณต้องการออกจากระบบผู้ดูแลหรือไม่?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'ออกจากระบบ',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    isAdmin = false;
                    document.getElementById('adminLoginBtn').classList.remove('hidden');
                    document.getElementById('adminLogoutBtn').classList.add('hidden');
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'ออกจากระบบแล้ว',
                        timer: 1000,
                        showConfirmButton: false,
                        toast: true,
                        position: 'top-end'
                    });
                    
                    updateTasksPage(); // Refresh to hide admin controls
                }
            });
        }

        // Task modal functions

        function closeTaskModal() {
            document.getElementById('taskModal').classList.remove('active');
            document.getElementById('taskForm').reset();
            clearImageSelection();
            document.getElementById('customResponsible').classList.add('hidden');
            document.getElementById('customPosition').classList.add('hidden');
            document.getElementById('customWorkGroup').classList.add('hidden');
            
            // Reset editing state
            editingTaskId = null;
            
            // Reset button text and modal title
            const saveButton = document.querySelector('#taskForm button[onclick="saveTask()"]');
            const modalTitle = document.querySelector('#taskModal h2');
            
            if (saveButton) {
                saveButton.innerHTML = '<i class="fas fa-save mr-2"></i>บันทึกงาน';
            }
            if (modalTitle) {
                modalTitle.textContent = 'มอบหมายงานใหม่';
            }
        }

        function openTaskModal() {
            document.getElementById('taskModal').classList.add('active');
            // Setup drag and drop when modal opens
            setTimeout(() => {
                setupDragAndDrop();
            }, 100);
        }

        // Handle image selection
        function handleImageSelect() {
            const fileInput = document.getElementById('personImage');
            const preview = document.getElementById('imagePreview');
            const dropZone = document.getElementById('imageDropZone');
            const dropZoneContent = document.getElementById('dropZoneContent');

            if (fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];
                
                // Validate file type
                const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/bmp', 'image/webp', 'image/svg+xml'];
                if (!validTypes.includes(file.type)) {
                    Swal.fire({
                        icon: 'error',
                        title: 'ไฟล์ไม่ถูกต้อง',
                        text: 'กรุณาเลือกไฟล์รูปภาพที่รองรับ (JPG, PNG, GIF, BMP, WebP, SVG)',
                        confirmButtonText: 'ตกลง'
                    });
                    fileInput.value = '';
                    return;
                }
                
                // Validate file size (5MB max)
                const maxSize = 5 * 1024 * 1024; // 5MB in bytes
                if (file.size > maxSize) {
                    Swal.fire({
                        icon: 'error',
                        title: 'ไฟล์ใหญ่เกินไป',
                        text: 'ขนาดไฟล์ต้องไม่เกิน 5MB กรุณาเลือกไฟล์ที่มีขนาดเล็กกว่า',
                        confirmButtonText: 'ตกลง'
                    });
                    fileInput.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    // Update drop zone to show selected image
                    dropZone.classList.remove('border-dashed', 'border-gray-300');
                    dropZone.classList.add('border-solid', 'border-green-400', 'bg-green-50');
                    
                    dropZoneContent.innerHTML = `
                        <div class="flex items-center justify-center space-x-4">
                            <img src="${e.target.result}" alt="Preview" class="w-16 h-16 rounded-full object-cover border-2 border-green-400">
                            <div class="text-left">
                                <p class="text-green-700 font-semibold">✓ อัปโหลดสำเร็จ</p>
                                <p class="text-sm text-green-600">${file.name}</p>
                                <p class="text-xs text-green-500">${(file.size / 1024).toFixed(1)} KB</p>
                            </div>
                            <button type="button" onclick="clearImageSelection()" class="text-red-500 hover:text-red-700 transition-colors" title="ลบรูปภาพ">
                                <i class="fas fa-times-circle text-xl"></i>
                            </button>
                        </div>
                    `;
                    
                    // Show larger preview
                    preview.innerHTML = `
                        <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                            <div class="flex items-center space-x-4">
                                <img src="${e.target.result}" alt="Preview" class="w-20 h-20 rounded-lg object-cover border-2 border-gray-300">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-800 mb-1">ตัวอย่างรูปภาพ</h4>
                                    <div class="text-sm text-gray-600 space-y-1">
                                        <p><i class="fas fa-file-image mr-2"></i>ชื่อไฟล์: ${file.name}</p>
                                        <p><i class="fas fa-weight mr-2"></i>ขนาด: ${(file.size / 1024).toFixed(1)} KB</p>
                                        <p><i class="fas fa-image mr-2"></i>ประเภท: ${file.type}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                };
                reader.onerror = function() {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: 'ไม่สามารถอ่านไฟล์ได้ กรุณาลองใหม่อีกครั้ง',
                        confirmButtonText: 'ตกลง'
                    });
                    fileInput.value = '';
                };
                reader.readAsDataURL(file);
            } else {
                clearImageSelection();
            }
        }

        // Clear image selection
        function clearImageSelection() {
            const fileInput = document.getElementById('personImage');
            const preview = document.getElementById('imagePreview');
            const dropZone = document.getElementById('imageDropZone');
            const dropZoneContent = document.getElementById('dropZoneContent');
            
            fileInput.value = '';
            preview.innerHTML = '';
            
            // Reset drop zone to original state
            dropZone.classList.remove('border-solid', 'border-green-400', 'bg-green-50');
            dropZone.classList.add('border-dashed', 'border-gray-300');
            
            dropZoneContent.innerHTML = `
                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                <p class="text-gray-600 mb-1">คลิกเพื่อเลือกรูปภาพ หรือลากไฟล์มาวางที่นี่</p>
                <p class="text-sm text-gray-500">รองรับไฟล์: JPG, PNG, GIF, BMP, WebP, SVG</p>
                <p class="text-xs text-gray-400 mt-1">ขนาดไฟล์สูงสุด: 5MB</p>
            `;
        }

        // Setup drag and drop functionality
        function setupDragAndDrop() {
            const dropZone = document.getElementById('imageDropZone');
            const fileInput = document.getElementById('personImage');
            
            if (!dropZone || !fileInput) return;

            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            // Highlight drop zone when item is dragged over it
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });

            // Handle dropped files
            dropZone.addEventListener('drop', handleDrop, false);

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            function highlight(e) {
                dropZone.classList.add('border-blue-400', 'bg-blue-50');
            }

            function unhighlight(e) {
                dropZone.classList.remove('border-blue-400', 'bg-blue-50');
            }

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;

                if (files.length > 0) {
                    fileInput.files = files;
                    handleImageSelect();
                }
            }
        }

        // Auto-fill person data
        function autoFillPersonData() {
            const responsibleSelect = document.getElementById('responsible');
            const customResponsible = document.getElementById('customResponsible');

            if (responsibleSelect.value === 'other') {
                customResponsible.classList.remove('hidden');
                return;
            } else {
                customResponsible.classList.add('hidden');
            }

            // Find existing staff data from tasks
            const staffData = getUniqueStaffData();
            const selectedStaff = staffData.find(staff => staff.name === responsibleSelect.value);
            
            if (selectedStaff) {
                // Set position if it exists in the dropdown
                const positionSelect = document.getElementById('position');
                if (positionSelect.querySelector(`option[value="${selectedStaff.position}"]`)) {
                    positionSelect.value = selectedStaff.position;
                }
                
                // Set work group if it exists in the dropdown
                const workGroupSelect = document.getElementById('workGroup');
                if (workGroupSelect.querySelector(`option[value="${selectedStaff.workGroup}"]`)) {
                    workGroupSelect.value = selectedStaff.workGroup;
                }
            }
        }

        // Handle position selection
        function handlePositionSelect() {
            const select = document.getElementById('position');
            const customInput = document.getElementById('customPosition');

            if (select.value === 'other') {
                customInput.classList.remove('hidden');
            } else {
                customInput.classList.add('hidden');
            }
        }

        // Handle work group selection
        function handleWorkGroupSelect() {
            const select = document.getElementById('workGroup');
            const customInput = document.getElementById('customWorkGroup');

            if (select.value === 'other') {
                customInput.classList.remove('hidden');
            } else {
                customInput.classList.add('hidden');
            }
        }

        // Save task
        function saveTask() {
            try {
                console.log('Starting saveTask function...');
                
                const isEditing = !!editingTaskId;
                console.log('Is editing:', isEditing);

                // Get form values with better error handling
                const responsibleSelect = document.getElementById('responsible');
                let responsibleName = '';
                
                if (!responsibleSelect) {
                    throw new Error('ไม่พบฟิลด์ผู้รับผิดชอบ');
                }
                
                if (responsibleSelect.value === 'other') {
                    const customInput = document.getElementById('customResponsible');
                    responsibleName = customInput ? customInput.value.trim() : '';
                } else if (responsibleSelect.value !== '') {
                    const selectedOption = responsibleSelect.options[responsibleSelect.selectedIndex];
                    responsibleName = selectedOption ? selectedOption.text : responsibleSelect.value;
                }

                console.log('Responsible name:', responsibleName);

                // Get other form values with validation
                const taskNameInput = document.getElementById('taskName');
                const positionSelect = document.getElementById('position');
                const taskDetailInput = document.getElementById('taskDetail');
                const workGroupSelect = document.getElementById('workGroup');
                const prioritySelect = document.getElementById('priority');
                const statusSelect = document.getElementById('status');
                const startDateInput = document.getElementById('startDate');
                const endDateInput = document.getElementById('endDate');

                // Check if all required elements exist
                if (!taskNameInput || !positionSelect || !workGroupSelect || 
                    !prioritySelect || !statusSelect || !startDateInput || !endDateInput) {
                    throw new Error('ไม่พบฟิลด์ที่จำเป็นในฟอร์ม');
                }

                // Get position value
                let positionValue = '';
                if (positionSelect.value === 'other') {
                    const customPositionInput = document.getElementById('customPosition');
                    positionValue = customPositionInput ? customPositionInput.value.trim() : '';
                } else {
                    positionValue = positionSelect.value;
                }

                // Get work group value
                let workGroupValue = '';
                if (workGroupSelect.value === 'other') {
                    const customWorkGroupInput = document.getElementById('customWorkGroup');
                    workGroupValue = customWorkGroupInput ? customWorkGroupInput.value.trim() : '';
                } else {
                    workGroupValue = workGroupSelect.value;
                }

                // Create form data object
                const formData = {
                    id: isEditing ? editingTaskId : Date.now() + Math.random(),
                    image: '', // Handle image separately
                    taskName: taskNameInput.value.trim(),
                    responsible: responsibleName,
                    position: positionValue,
                    taskDetail: taskDetailInput.value.trim(),
                    workGroup: workGroupValue,
                    priority: prioritySelect.value,
                    status: statusSelect.value,
                    startDate: startDateInput.value,
                    endDate: endDateInput.value,
                    createdDate: isEditing ? 
                               (tasks.find(t => t.id === editingTaskId)?.createdDate || new Date().toISOString().split('T')[0]) : 
                               new Date().toISOString().split('T')[0]
                };

                console.log('Form data created:', formData);

                // Validate required fields
                const requiredFields = [
                    { field: 'taskName', name: 'ชื่องาน' },
                    { field: 'responsible', name: 'ผู้รับผิดชอบ' },
                    { field: 'position', name: 'ตำแหน่ง' },
                    { field: 'workGroup', name: 'กลุ่มงาน' },
                    { field: 'priority', name: 'ระดับความสำคัญ' },
                    { field: 'status', name: 'สถานะ' },
                    { field: 'startDate', name: 'วันเริ่มต้น' },
                    { field: 'endDate', name: 'วันสิ้นสุด' }
                ];

                const missingFields = requiredFields.filter(field => !formData[field.field]);
                
                if (missingFields.length > 0) {
                    const missingFieldNames = missingFields.map(f => f.name).join(', ');
                    Swal.fire({
                        icon: 'warning',
                        title: 'ข้อมูลไม่ครบถ้วน',
                        text: `กรุณากรอกข้อมูล: ${missingFieldNames}`,
                        confirmButtonText: 'ตกลง'
                    });
                    return;
                }

                // Validate date range
                if (new Date(formData.startDate) > new Date(formData.endDate)) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'วันที่ไม่ถูกต้อง',
                        text: 'วันเริ่มต้นต้องไม่เกินวันสิ้นสุด',
                        confirmButtonText: 'ตกลง'
                    });
                    return;
                }

                // Initialize tasks array if needed
                if (!Array.isArray(tasks)) {
                    console.log('Initializing tasks array');
                    tasks = [];
                }

                // Handle image upload after validation passes
                const fileInput = document.getElementById('personImage');
                if (fileInput && fileInput.files && fileInput.files[0]) {
                    console.log('Processing image...');
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        formData.image = e.target.result;
                        completeSaveTask(formData, isEditing);
                    };
                    reader.onerror = function() {
                        console.warn('Image upload failed, continuing without image');
                        formData.image = isEditing ? (tasks.find(t => t.id === editingTaskId)?.image || '') : '';
                        completeSaveTask(formData, isEditing);
                    };
                    reader.readAsDataURL(fileInput.files[0]);
                } else {
                    // No new image
                    if (isEditing) {
                        const existingTask = tasks.find(t => t.id === editingTaskId);
                        formData.image = existingTask?.image || '';
                    }
                    completeSaveTask(formData, isEditing);
                }

            } catch (error) {
                console.error('Error in saveTask:', error);
                
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: error.message || 'ไม่สามารถบันทึกงานได้ กรุณาลองใหม่อีกครั้ง',
                    confirmButtonText: 'ตกลง'
                });
            }
        }

        // Complete the save task process
        function completeSaveTask(formData, isEditing) {
            try {
                console.log('Completing save task...', formData);

                // Save task to array
                if (isEditing) {
                    const taskIndex = tasks.findIndex(t => t.id === editingTaskId);
                    if (taskIndex !== -1) {
                        // Preserve Firebase key
                        formData.firebaseKey = tasks[taskIndex].firebaseKey;
                        tasks[taskIndex] = formData;
                        console.log('Updated existing task at index:', taskIndex);
                    } else {
                        tasks.push(formData);
                        console.log('Added as new task (original not found)');
                    }
                } else {
                    tasks.push(formData);
                    console.log('Added new task, total tasks:', tasks.length);
                }
                
                // Save to localStorage immediately
                try {
                    localStorage.setItem('tasks', JSON.stringify(tasks));
                    console.log('Saved to localStorage successfully');
                } catch (storageError) {
                    console.error('LocalStorage error:', storageError);
                    // Continue anyway
                }
                
                // Try Firebase in background
                if (firebaseInitialized && window.firebaseDB) {
                    console.log('Attempting Firebase save...');
                    if (isEditing) {
                        updateTaskInFirebase(editingTaskId, formData).catch(error => {
                            console.warn('Firebase update failed:', error);
                        });
                    } else {
                        saveTaskToFirebase(formData).catch(error => {
                            console.warn('Firebase save failed:', error);
                        });
                    }
                } else {
                    console.log('Firebase not available, using localStorage only');
                }
                
                // Close modal and refresh
                closeTaskModal();
                refreshAllViews();
                
                // Show success
                Swal.fire({
                    icon: 'success',
                    title: isEditing ? 'อัพเดทงานสำเร็จ!' : 'บันทึกงานสำเร็จ!',
                    timer: 1500,
                    showConfirmButton: false,
                    toast: true,
                    position: 'top-end'
                });

            } catch (error) {
                console.error('Error in completeSaveTask:', error);
                
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถบันทึกงานได้ กรุณาลองใหม่อีกครั้ง',
                    confirmButtonText: 'ตกลง'
                });
            }
        }

        // Refresh all views
        function refreshAllViews() {
            updateDashboard();
            updateTasksPage();
            updateGanttChart();
            updateReportsPage();
        }

        // Helper function to safely destroy DataTable
        function safeDestroyDataTable(tableId, dataTableInstance) {
            try {
                if (dataTableInstance && $.fn.DataTable.isDataTable(tableId)) {
                    dataTableInstance.destroy();
                    return null;
                }
            } catch (error) {
                console.warn(`Error destroying DataTable ${tableId}:`, error);
                // Force clear the DataTable instance
                try {
                    $(tableId).DataTable().destroy();
                } catch (forceError) {
                    console.warn(`Force destroy also failed for ${tableId}:`, forceError);
                }
            }
            return null;
        }

        // Helper function to safely initialize DataTable
        function safeInitDataTable(tableId, options) {
            try {
                // Check if table element exists
                if (!$(tableId).length) {
                    console.warn(`Table element ${tableId} not found`);
                    return null;
                }

                // Check if already initialized
                if ($.fn.DataTable.isDataTable(tableId)) {
                    console.warn(`DataTable ${tableId} already initialized`);
                    return $(tableId).DataTable();
                }

                // Initialize with default options
                const defaultOptions = {
                    responsive: false,
                    autoWidth: false,
                    destroy: true,
                    language: {
                        "decimal": "",
                        "emptyTable": "ไม่มีข้อมูลในตาราง",
                        "info": "แสดง _START_ ถึง _END_ จาก _TOTAL_ รายการ",
                        "infoEmpty": "แสดง 0 ถึง 0 จาก 0 รายการ",
                        "infoFiltered": "(กรองจาก _MAX_ รายการทั้งหมด)",
                        "infoPostFix": "",
                        "thousands": ",",
                        "lengthMenu": "แสดง _MENU_ รายการ",
                        "loadingRecords": "กำลังโหลด...",
                        "processing": "กำลังประมวลผล...",
                        "search": "ค้นหา:",
                        "zeroRecords": "ไม่พบข้อมูลที่ตรงกัน",
                        "paginate": {
                            "first": "หน้าแรก",
                            "last": "หน้าสุดท้าย",
                            "next": "ถัดไป",
                            "previous": "ก่อนหน้า"
                        }
                    }
                };

                // Merge options
                const finalOptions = { ...defaultOptions, ...options };

                return $(tableId).DataTable(finalOptions);
            } catch (error) {
                console.error(`Error initializing DataTable ${tableId}:`, error);
                return null;
            }
        }

        // Firebase functions
        async function loadTasksFromFirebase() {
            if (!firebaseInitialized || !window.firebaseDB) {
                console.log('Firebase not initialized yet');
                return;
            }

            try {
                const tasksRef = window.firebaseDB.ref(window.firebaseDB.database, 'tasks');
                const snapshot = await window.firebaseDB.get(tasksRef);
                
                if (snapshot.exists()) {
                    const firebaseTasks = snapshot.val();
                    tasks = Object.keys(firebaseTasks).map(key => ({
                        ...firebaseTasks[key],
                        firebaseKey: key
                    }));
                } else {
                    // Load sample data if no data exists
                    await loadSampleDataToFirebase();
                }
                
                updateDashboard();
                updateTasksPage();
                updateGanttChart();
                updateReportsPage();
            } catch (error) {
                console.error('Error loading tasks from Firebase:', error);
                // Fallback to localStorage
                loadSampleDataLocal();
            }
        }

        async function saveTaskToFirebase(task) {
            if (!firebaseInitialized || !window.firebaseDB) {
                console.log('Firebase not initialized, saving to localStorage');
                localStorage.setItem('tasks', JSON.stringify(tasks));
                return;
            }

            try {
                const tasksRef = window.firebaseDB.ref(window.firebaseDB.database, 'tasks');
                const newTaskRef = window.firebaseDB.push(tasksRef);
                await window.firebaseDB.set(newTaskRef, task);
                
                // Add firebase key to local task
                task.firebaseKey = newTaskRef.key;
                
                console.log('Task saved to Firebase successfully');
            } catch (error) {
                console.error('Error saving task to Firebase:', error);
                // Fallback to localStorage
                localStorage.setItem('tasks', JSON.stringify(tasks));
            }
        }

        async function updateTaskInFirebase(taskId, updatedTask) {
            if (!firebaseInitialized || !window.firebaseDB) {
                console.log('Firebase not initialized');
                return;
            }

            try {
                // Convert taskId to number for comparison
                const numericTaskId = typeof taskId === 'string' ? parseFloat(taskId) : taskId;
                const task = tasks.find(t => {
                    const taskIdNum = typeof t.id === 'string' ? parseFloat(t.id) : t.id;
                    return taskIdNum === numericTaskId;
                });
                
                if (task && task.firebaseKey) {
                    const taskRef = window.firebaseDB.ref(window.firebaseDB.database, `tasks/${task.firebaseKey}`);
                    await window.firebaseDB.set(taskRef, updatedTask);
                    console.log('Task updated in Firebase successfully');
                }
            } catch (error) {
                console.error('Error updating task in Firebase:', error);
            }
        }

        async function deleteTaskFromFirebase(taskId) {
            if (!firebaseInitialized || !window.firebaseDB) {
                console.log('Firebase not initialized');
                return;
            }

            try {
                const task = tasks.find(t => t.id === taskId);
                if (task && task.firebaseKey) {
                    const taskRef = window.firebaseDB.ref(window.firebaseDB.database, `tasks/${task.firebaseKey}`);
                    await window.firebaseDB.remove(taskRef);
                    console.log('Task deleted from Firebase successfully');
                }
            } catch (error) {
                console.error('Error deleting task from Firebase:', error);
            }
        }

        async function loadSampleDataToFirebase() {
            // No sample data - start with empty database
            tasks = [];
            console.log('Starting with empty database');
        }

        function loadSampleDataLocal() {
            const savedTasks = localStorage.getItem('tasks');
            if (savedTasks) {
                tasks = JSON.parse(savedTasks);
            } else {
                tasks = [];
                localStorage.setItem('tasks', JSON.stringify(tasks));
            }
            updateDashboard();
            updateTasksPage();
            updateGanttChart();
            updateReportsPage();
        }

        // Update dashboard
        function updateDashboard() {
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(t => t.status === 'เสร็จสมบูรณ์').length;
            const inProgressTasks = tasks.filter(t => t.status === 'กำลังดำเนินการ').length;
            const delayedTasks = tasks.filter(t => t.status === 'ติดปัญหา/ล่าช้า').length;

            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById('completedTasks').textContent = completedTasks;
            document.getElementById('inProgressTasks').textContent = inProgressTasks;
            document.getElementById('delayedTasks').textContent = delayedTasks;

            updateCharts();
            updateStaffTable();
        }

        // Update charts
        function updateCharts() {
            try {
                // Get canvas elements
                const statusCanvas = document.getElementById('statusChart');
                const groupCanvas = document.getElementById('groupChart');
                const priorityCanvas = document.getElementById('priorityChart');
                const monthlyCanvas = document.getElementById('monthlyChart');
                const performanceCanvas = document.getElementById('performanceChart');
                const workloadCanvas = document.getElementById('workloadChart');
                
                // Destroy existing chart instances if they exist
                const charts = [statusChart, groupChart, priorityChart, monthlyChart, performanceChart, workloadChart];
                charts.forEach(chart => {
                    if (chart) {
                        chart.destroy();
                    }
                });
                
                // Reset chart variables
                statusChart = groupChart = priorityChart = monthlyChart = performanceChart = workloadChart = null;

                // Check if there are any tasks
                if (!tasks || tasks.length === 0) {
                    createEmptyCharts();
                    return;
                }

                // 1. Status Chart (Doughnut)
                if (statusCanvas) {
                    const statusCtx = statusCanvas.getContext('2d');
                    const statusCounts = {
                        completed: tasks.filter(t => t.status === 'เสร็จสมบูรณ์').length,
                        inProgress: tasks.filter(t => t.status === 'กำลังดำเนินการ').length,
                        delayed: tasks.filter(t => t.status === 'ติดปัญหา/ล่าช้า').length,
                        notStarted: tasks.filter(t => t.status === 'ยังไม่เริ่ม').length
                    };

                    statusChart = new Chart(statusCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['เสร็จสมบูรณ์', 'กำลังดำเนินการ', 'ติดปัญหา/ล่าช้า', 'ยังไม่เริ่ม'],
                            datasets: [{
                                data: [statusCounts.completed, statusCounts.inProgress, statusCounts.delayed, statusCounts.notStarted],
                                backgroundColor: ['#10b981', '#ec4899', '#f59e0b', '#ef4444'],
                                borderWidth: 2,
                                borderColor: '#ffffff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 20,
                                        usePointStyle: true
                                    }
                                }
                            }
                        }
                    });
                }

                // 2. Group Chart (Bar)
                if (groupCanvas) {
                    const groupCtx = groupCanvas.getContext('2d');
                    const groups = [...new Set(tasks.map(t => t.workGroup).filter(g => g && g.trim() !== ''))];
                    
                    if (groups.length === 0) {
                        groups.push('ไม่ระบุกลุ่มงาน');
                    }

                    groupChart = new Chart(groupCtx, {
                        type: 'bar',
                        data: {
                            labels: groups,
                            datasets: [{
                                label: 'จำนวนงาน',
                                data: groups.map(group => {
                                    if (group === 'ไม่ระบุกลุ่มงาน') {
                                        return tasks.filter(t => !t.workGroup || t.workGroup.trim() === '').length;
                                    }
                                    return tasks.filter(t => t.workGroup === group).length;
                                }),
                                backgroundColor: 'rgba(236, 72, 153, 0.8)',
                                borderColor: 'rgba(236, 72, 153, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                }

                // 3. Priority Chart (Pie)
                if (priorityCanvas) {
                    const priorityCtx = priorityCanvas.getContext('2d');
                    const priorityCounts = {
                        urgent: tasks.filter(t => t.priority === 'สำคัญและเร่งด่วน').length,
                        important: tasks.filter(t => t.priority === 'สำคัญแต่ไม่เร่งด่วน').length,
                        normal: tasks.filter(t => t.priority === 'ไม่สำคัญแต่เร่งด่วน').length,
                        low: tasks.filter(t => t.priority === 'ไม่สำคัญและไม่เร่งด่วน').length
                    };

                    priorityChart = new Chart(priorityCtx, {
                        type: 'pie',
                        data: {
                            labels: ['สำคัญและเร่งด่วน', 'สำคัญแต่ไม่เร่งด่วน', 'ไม่สำคัญแต่เร่งด่วน', 'ไม่สำคัญและไม่เร่งด่วน'],
                            datasets: [{
                                data: [priorityCounts.urgent, priorityCounts.important, priorityCounts.normal, priorityCounts.low],
                                backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6', '#6b7280'],
                                borderWidth: 2,
                                borderColor: '#ffffff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 15,
                                        usePointStyle: true,
                                        font: {
                                            size: 11
                                        }
                                    }
                                }
                            }
                        }
                    });
                }

                // 4. Monthly Chart (Line)
                if (monthlyCanvas) {
                    const monthlyCtx = monthlyCanvas.getContext('2d');
                    const monthlyData = getMonthlyTaskData();

                    monthlyChart = new Chart(monthlyCtx, {
                        type: 'line',
                        data: {
                            labels: ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'],
                            datasets: [{
                                label: 'งานใหม่',
                                data: monthlyData.newTasks,
                                borderColor: '#ec4899',
                                backgroundColor: 'rgba(236, 72, 153, 0.1)',
                                tension: 0.4,
                                fill: true
                            }, {
                                label: 'งานเสร็จ',
                                data: monthlyData.completedTasks,
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'top'
                                }
                            }
                        }
                    });
                }

                // 5. Performance Chart (Radar)
                if (performanceCanvas) {
                    const performanceCtx = performanceCanvas.getContext('2d');
                    const performanceData = getPerformanceData();

                    performanceChart = new Chart(performanceCtx, {
                        type: 'radar',
                        data: {
                            labels: ['ความเร็ว', 'คุณภาพ', 'ความสม่ำเสมอ', 'การทำงานร่วมกัน', 'นวัตกรรม', 'ความรับผิดชอบ'],
                            datasets: [{
                                label: 'ประสิทธิภาพโดยรวม',
                                data: performanceData,
                                borderColor: '#ec4899',
                                backgroundColor: 'rgba(236, 72, 153, 0.2)',
                                pointBackgroundColor: '#ec4899',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                r: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: {
                                        stepSize: 20
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'top'
                                }
                            }
                        }
                    });
                }

                // 6. Workload Chart (Horizontal Bar)
                if (workloadCanvas) {
                    const workloadCtx = workloadCanvas.getContext('2d');
                    const workloadData = getWorkloadData();

                    workloadChart = new Chart(workloadCtx, {
                        type: 'bar',
                        data: {
                            labels: workloadData.labels,
                            datasets: [{
                                label: 'งานทั้งหมด',
                                data: workloadData.total,
                                backgroundColor: 'rgba(236, 72, 153, 0.8)',
                                borderColor: 'rgba(236, 72, 153, 1)',
                                borderWidth: 1
                            }, {
                                label: 'งานเสร็จ',
                                data: workloadData.completed,
                                backgroundColor: 'rgba(16, 185, 129, 0.8)',
                                borderColor: 'rgba(16, 185, 129, 1)',
                                borderWidth: 1
                            }, {
                                label: 'งานล่าช้า',
                                data: workloadData.delayed,
                                backgroundColor: 'rgba(245, 158, 11, 0.8)',
                                borderColor: 'rgba(245, 158, 11, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            indexAxis: 'y',
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'top'
                                }
                            }
                        }
                    });
                }

            } catch (error) {
                console.error('Error updating charts:', error);
            }
        }

        // Helper functions for chart data
        function createEmptyCharts() {
            const canvases = ['statusChart', 'groupChart', 'priorityChart', 'monthlyChart', 'performanceChart', 'workloadChart'];
            
            canvases.forEach(canvasId => {
                const canvas = document.getElementById(canvasId);
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['ไม่มีข้อมูล'],
                            datasets: [{
                                data: [1],
                                backgroundColor: ['#e5e7eb']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                }
            });
        }

        function getMonthlyTaskData() {
            const monthlyData = {
                newTasks: new Array(12).fill(0),
                completedTasks: new Array(12).fill(0)
            };

            tasks.forEach(task => {
                if (task.startDate) {
                    const startMonth = new Date(task.startDate).getMonth();
                    monthlyData.newTasks[startMonth]++;
                }
                
                if (task.status === 'เสร็จสมบูรณ์' && task.endDate) {
                    const endMonth = new Date(task.endDate).getMonth();
                    monthlyData.completedTasks[endMonth]++;
                }
            });

            return monthlyData;
        }

        function getPerformanceData() {
            const totalTasks = tasks.length;
            if (totalTasks === 0) return [0, 0, 0, 0, 0, 0];

            const completedTasks = tasks.filter(t => t.status === 'เสร็จสมบูรณ์').length;
            const onTimeTasks = tasks.filter(t => {
                if (t.status === 'เสร็จสมบูรณ์') {
                    const daysLeft = calculateDaysLeft(t.endDate);
                    return daysLeft >= 0;
                }
                return false;
            }).length;

            // Calculate performance metrics (0-100 scale)
            const speed = Math.round((completedTasks / totalTasks) * 100);
            const quality = Math.round((onTimeTasks / Math.max(completedTasks, 1)) * 100);
            const consistency = Math.round(Math.random() * 30 + 70); // Simulated
            const teamwork = Math.round(Math.random() * 25 + 75); // Simulated
            const innovation = Math.round(Math.random() * 35 + 65); // Simulated
            const responsibility = Math.round((completedTasks / totalTasks) * 100);

            return [speed, quality, consistency, teamwork, innovation, responsibility];
        }

        function getWorkloadData() {
            const staffData = getUniqueStaffData();
            const labels = staffData.map(staff => staff.name);
            const total = [];
            const completed = [];
            const delayed = [];

            staffData.forEach(staff => {
                const staffTasks = tasks.filter(t => t.responsible === staff.name);
                total.push(staffTasks.length);
                completed.push(staffTasks.filter(t => t.status === 'เสร็จสมบูรณ์').length);
                delayed.push(staffTasks.filter(t => t.status === 'ติดปัญหา/ล่าช้า').length);
            });

            return { labels, total, completed, delayed };
        }

        // Update staff table
        function updateStaffTable() {
            try {
                const staffData = getUniqueStaffData();
                
                // Destroy existing DataTable if it exists
                if (staffDataTable && $.fn.DataTable.isDataTable('#staffTable')) {
                    staffDataTable.destroy();
                    staffDataTable = null;
                }

                const tbody = document.getElementById('staffTableBody');
                if (!tbody) {
                    console.error('Staff table body not found');
                    return;
                }
                
                tbody.innerHTML = '';

                if (staffData.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="8" class="text-center text-gray-500 py-8">
                            ยังไม่มีข้อมูลบุคลากร<br>
                            <small>กรุณาเพิ่มงานใหม่เพื่อดูข้อมูลบุคลากร</small>
                        </td>
                    `;
                    tbody.appendChild(row);
                    return;
                }

                // Add data to table body
                staffData.forEach(staff => {
                    const staffTasks = tasks.filter(t => t.responsible === staff.name);
                    const totalTasks = staffTasks.length;
                    const inProgress = staffTasks.filter(t => t.status === 'กำลังดำเนินการ').length;
                    const completed = staffTasks.filter(t => t.status === 'เสร็จสมบูรณ์').length;
                    const delayed = staffTasks.filter(t => t.status === 'ติดปัญหา/ล่าช้า').length;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="text-center">
                            ${staff.image ? 
                                `<img src="${staff.image}" alt="${staff.name}" class="w-10 h-10 rounded-full object-cover mx-auto" onerror="this.style.display='none';">` : 
                                '<div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center mx-auto"><i class="fas fa-user text-gray-400"></i></div>'
                            }
                        </td>
                        <td>${staff.name}</td>
                        <td>${staff.position}</td>
                        <td>${staff.workGroup}</td>
                        <td class="text-center">${totalTasks}</td>
                        <td class="text-center">${inProgress}</td>
                        <td class="text-center">${completed}</td>
                        <td class="text-center">${delayed}</td>
                    `;
                    tbody.appendChild(row);
                });

                // Initialize DataTable with error handling
                setTimeout(() => {
                    try {
                        if ($('#staffTable').length && !$.fn.DataTable.isDataTable('#staffTable')) {
                            staffDataTable = $('#staffTable').DataTable({
                                pageLength: 10,
                                lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "ทั้งหมด"]],
                                language: {
                                    "decimal": "",
                                    "emptyTable": "ไม่มีข้อมูลในตาราง",
                                    "info": "แสดง _START_ ถึง _END_ จาก _TOTAL_ รายการ",
                                    "infoEmpty": "แสดง 0 ถึง 0 จาก 0 รายการ",
                                    "infoFiltered": "(กรองจาก _MAX_ รายการทั้งหมด)",
                                    "infoPostFix": "",
                                    "thousands": ",",
                                    "lengthMenu": "แสดง _MENU_ รายการ",
                                    "loadingRecords": "กำลังโหลด...",
                                    "processing": "กำลังประมวลผล...",
                                    "search": "ค้นหา:",
                                    "zeroRecords": "ไม่พบข้อมูลที่ตรงกัน",
                                    "paginate": {
                                        "first": "หน้าแรก",
                                        "last": "หน้าสุดท้าย",
                                        "next": "ถัดไป",
                                        "previous": "ก่อนหน้า"
                                    }
                                },
                                columnDefs: [
                                    { targets: [0], orderable: false, searchable: false, className: 'text-center' },
                                    { targets: [4, 5, 6, 7], className: 'text-center' }
                                ],
                                order: [[1, 'asc']],
                                responsive: false,
                                autoWidth: false,
                                destroy: true
                            });
                        }
                    } catch (error) {
                        console.error('Error initializing staff DataTable:', error);
                    }
                }, 100);
                
            } catch (error) {
                console.error('Error in updateStaffTable:', error);
            }
        }

        // Update tasks page
        function updateTasksPage() {
            updatePendingTasks();
            updateCompletedTasks();
        }

        // Update pending tasks
        function updatePendingTasks() {
            try {
                // Destroy existing DataTable if it exists
                if (pendingTasksDataTable && $.fn.DataTable.isDataTable('#pendingTasksTable')) {
                    pendingTasksDataTable.destroy();
                    pendingTasksDataTable = null;
                }

                const tbody = document.getElementById('pendingTasksBody');
                if (!tbody) {
                    console.error('Pending tasks table body not found');
                    return;
                }
                
                tbody.innerHTML = '';

                // Show/hide admin column based on admin status
                const adminColumns = document.querySelectorAll('.admin-column');
                adminColumns.forEach(col => {
                    col.style.display = isAdmin ? 'table-cell' : 'none';
                });

                const pendingTasks = tasks.filter(t => t.status !== 'เสร็จสมบูรณ์');

                if (pendingTasks.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="11" class="text-center text-gray-500 py-8">
                            ยังไม่มีงานที่ต้องจัดการ<br>
                            <small>กรุณาเพิ่มงานใหม่เพื่อดูรายการงาน</small>
                        </td>
                    `;
                    tbody.appendChild(row);
                    return;
                }

                // Add data to table body
                pendingTasks.forEach(task => {
                    const daysLeft = calculateDaysLeft(task.endDate);
                    const priorityClass = getPriorityClass(task.priority);

                    const row = document.createElement('tr');
                    
                    let rowHTML = `
                        <td class="text-center">
                            ${task.image ? 
                                `<img src="${task.image}" alt="${task.responsible}" class="w-10 h-10 rounded-full object-cover mx-auto" onerror="this.style.display='none';">` : 
                                '<div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center mx-auto"><i class="fas fa-user text-gray-400"></i></div>'
                            }
                        </td>
                        <td>${task.taskName || 'ไม่ระบุ'}</td>
                        <td>${task.responsible || 'ไม่ระบุ'}</td>
                        <td>${task.position || 'ไม่ระบุ'}</td>
                        <td>${task.workGroup || 'ไม่ระบุ'}</td>
                        <td class="text-center">
                            <span class="${priorityClass} text-white px-2 py-1 rounded-full text-sm">${task.priority || 'ไม่ระบุ'}</span>
                        </td>
                        <td class="text-center">
                            <span class="px-2 py-1 rounded-full text-sm ${getStatusClass(task.status)}">${task.status || 'ไม่ระบุ'}</span>
                        </td>
                        <td class="text-center">${formatDate(task.startDate)}</td>
                        <td class="text-center">${formatDate(task.endDate)}</td>
                        <td class="text-center">
                            <span class="${daysLeft < 0 ? 'text-red-600 font-bold' : daysLeft < 7 ? 'text-yellow-600 font-bold' : 'text-gray-600'}">${daysLeft < 0 ? 'เกินกำหนด' : daysLeft + ' วัน'}</span>
                        </td>
                        <td class="text-center admin-column" style="display: ${isAdmin ? 'table-cell' : 'none'}">
                            ${isAdmin ? `
                                <div class="flex gap-2 justify-center">
                                    <button onclick="editTask(${task.id})" class="bg-pink-500 text-white px-3 py-1 rounded hover:bg-pink-600 text-sm transition-colors" title="แก้ไขงาน">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteTask(${task.id})" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm transition-colors" title="ลบงาน">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            ` : ''}
                        </td>
                    `;

                    row.innerHTML = rowHTML;
                    tbody.appendChild(row);
                });

                // Initialize DataTable with error handling
                setTimeout(() => {
                    try {
                        if ($('#pendingTasksTable').length && !$.fn.DataTable.isDataTable('#pendingTasksTable')) {
                            const columnDefs = [
                                { targets: [0], orderable: false, searchable: false, className: 'text-center' },
                                { targets: [5, 6, 7, 8, 9, 10], className: 'text-center' },
                                { targets: [10], orderable: false, searchable: false, className: 'text-center' }
                            ];

                            pendingTasksDataTable = $('#pendingTasksTable').DataTable({
                                pageLength: 10,
                                lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "ทั้งหมด"]],
                                language: {
                                    "decimal": "",
                                    "emptyTable": "ไม่มีข้อมูลในตาราง",
                                    "info": "แสดง _START_ ถึง _END_ จาก _TOTAL_ รายการ",
                                    "infoEmpty": "แสดง 0 ถึง 0 จาก 0 รายการ",
                                    "infoFiltered": "(กรองจาก _MAX_ รายการทั้งหมด)",
                                    "infoPostFix": "",
                                    "thousands": ",",
                                    "lengthMenu": "แสดง _MENU_ รายการ",
                                    "loadingRecords": "กำลังโหลด...",
                                    "processing": "กำลังประมวลผล...",
                                    "search": "ค้นหา:",
                                    "zeroRecords": "ไม่พบข้อมูลที่ตรงกัน",
                                    "paginate": {
                                        "first": "หน้าแรก",
                                        "last": "หน้าสุดท้าย",
                                        "next": "ถัดไป",
                                        "previous": "ก่อนหน้า"
                                    }
                                },
                                columnDefs: columnDefs,
                                order: [[7, 'asc']], // Sort by start date
                                responsive: false,
                                autoWidth: false,
                                destroy: true
                            });
                        }
                    } catch (error) {
                        console.error('Error initializing pending tasks DataTable:', error);
                    }
                }, 100);
                
            } catch (error) {
                console.error('Error in updatePendingTasks:', error);
            }
        }

        // Update completed tasks
        function updateCompletedTasks() {
            try {
                // Destroy existing DataTable if it exists
                if (completedTasksDataTable && $.fn.DataTable.isDataTable('#completedTasksTable')) {
                    completedTasksDataTable.destroy();
                    completedTasksDataTable = null;
                }

                const tbody = document.getElementById('completedTasksBody');
                if (!tbody) {
                    console.error('Completed tasks table body not found');
                    return;
                }
                
                tbody.innerHTML = '';

                // Show/hide admin column based on admin status
                const completedAdminColumns = document.querySelectorAll('.completed-admin-column');
                completedAdminColumns.forEach(col => {
                    col.style.display = isAdmin ? 'table-cell' : 'none';
                });

                const completedTasks = tasks.filter(t => t.status === 'เสร็จสมบูรณ์');

                if (completedTasks.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="8" class="text-center text-gray-500 py-8">
                            ยังไม่มีงานที่เสร็จสิ้น<br>
                            <small>งานที่มีสถานะ "เสร็จสมบูรณ์" จะแสดงที่นี่</small>
                        </td>
                    `;
                    tbody.appendChild(row);
                    return;
                }

                // Add data to table body
                completedTasks.forEach(task => {
                    const duration = calculateDuration(task.startDate, task.endDate);

                    const row = document.createElement('tr');
                    
                    let rowHTML = `
                        <td class="text-center">
                            ${task.image ? 
                                `<img src="${task.image}" alt="${task.responsible}" class="w-10 h-10 rounded-full object-cover mx-auto" onerror="this.style.display='none';">` : 
                                '<div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center mx-auto"><i class="fas fa-user text-gray-400"></i></div>'
                            }
                        </td>
                        <td>${task.taskName || 'ไม่ระบุ'}</td>
                        <td>${task.responsible || 'ไม่ระบุ'}</td>
                        <td>${task.position || 'ไม่ระบุ'}</td>
                        <td>${task.workGroup || 'ไม่ระบุ'}</td>
                        <td class="text-center">${formatDate(task.endDate)}</td>
                        <td class="text-center">${duration} วัน</td>
                        <td class="text-center completed-admin-column" style="display: ${isAdmin ? 'table-cell' : 'none'}">
                            ${isAdmin ? `
                                <div class="flex gap-2 justify-center">
                                    <button onclick="editTask(${task.id})" class="bg-pink-500 text-white px-3 py-1 rounded hover:bg-pink-600 text-sm transition-colors" title="แก้ไขงาน">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteTask(${task.id})" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm transition-colors" title="ลบงาน">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            ` : ''}
                        </td>
                    `;

                    row.innerHTML = rowHTML;
                    tbody.appendChild(row);
                });

                // Initialize DataTable with error handling
                setTimeout(() => {
                    try {
                        if ($('#completedTasksTable').length && !$.fn.DataTable.isDataTable('#completedTasksTable')) {
                            const columnDefs = [
                                { targets: [0], orderable: false, searchable: false, className: 'text-center' },
                                { targets: [5, 6, 7], className: 'text-center' },
                                { targets: [7], orderable: false, searchable: false, className: 'text-center' }
                            ];

                            completedTasksDataTable = $('#completedTasksTable').DataTable({
                                pageLength: 10,
                                lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "ทั้งหมด"]],
                                language: {
                                    "decimal": "",
                                    "emptyTable": "ไม่มีข้อมูลในตาราง",
                                    "info": "แสดง _START_ ถึง _END_ จาก _TOTAL_ รายการ",
                                    "infoEmpty": "แสดง 0 ถึง 0 จาก 0 รายการ",
                                    "infoFiltered": "(กรองจาก _MAX_ รายการทั้งหมด)",
                                    "infoPostFix": "",
                                    "thousands": ",",
                                    "lengthMenu": "แสดง _MENU_ รายการ",
                                    "loadingRecords": "กำลังโหลด...",
                                    "processing": "กำลังประมวลผล...",
                                    "search": "ค้นหา:",
                                    "zeroRecords": "ไม่พบข้อมูลที่ตรงกัน",
                                    "paginate": {
                                        "first": "หน้าแรก",
                                        "last": "หน้าสุดท้าย",
                                        "next": "ถัดไป",
                                        "previous": "ก่อนหน้า"
                                    }
                                },
                                columnDefs: columnDefs,
                                order: [[5, 'desc']], // Sort by completion date (newest first)
                                responsive: false,
                                autoWidth: false,
                                destroy: true
                            });
                        }
                    } catch (error) {
                        console.error('Error initializing completed tasks DataTable:', error);
                    }
                }, 100);
                
            } catch (error) {
                console.error('Error in updateCompletedTasks:', error);
            }
        }

        // Update Gantt chart
        function updateGanttChart() {
            const ganttBody = document.getElementById('ganttBody');
            if (!ganttBody) {
                console.warn('Gantt body element not found');
                return;
            }
            
            ganttBody.innerHTML = '';
            
            // Update responsible filter options
            updateGanttFilters();

            if (!tasks || tasks.length === 0) {
                const noDataDiv = document.createElement('div');
                noDataDiv.className = 'grid grid-cols-16 gap-2 text-center py-12 text-gray-500';
                noDataDiv.innerHTML = `
                    <div class="col-span-16">
                        <div class="mb-4">
                            <i class="fas fa-chart-gantt text-6xl text-pink-300"></i>
                        </div>
                        <h3 class="text-xl font-semibold mb-2 text-pink-600">ยังไม่มีข้อมูลแผนปฏิบัติการ</h3>
                        <p class="text-pink-500">กรุณาเพิ่มงานใหม่เพื่อดูแผนปฏิบัติการ</p>
                    </div>
                `;
                ganttBody.appendChild(noDataDiv);
                return;
            }

            // Filter tasks based on selected filters
            let filteredTasks = [...tasks];
            const statusFilter = document.getElementById('statusFilter');
            const responsibleFilter = document.getElementById('responsibleFilter');
            const yearFilter = document.getElementById('yearFilter');
            
            if (statusFilter && statusFilter.value) {
                filteredTasks = filteredTasks.filter(task => task.status === statusFilter.value);
            }
            
            if (responsibleFilter && responsibleFilter.value) {
                filteredTasks = filteredTasks.filter(task => task.responsible === responsibleFilter.value);
            }

            if (yearFilter && yearFilter.value) {
                const selectedYear = parseInt(yearFilter.value);
                filteredTasks = filteredTasks.filter(task => {
                    const taskStartYear = new Date(task.startDate).getFullYear();
                    const taskEndYear = new Date(task.endDate).getFullYear();
                    return taskStartYear === selectedYear || taskEndYear === selectedYear;
                });
            }

            if (filteredTasks.length === 0) {
                const noDataDiv = document.createElement('div');
                noDataDiv.className = 'grid grid-cols-16 gap-2 text-center py-12 text-gray-500';
                noDataDiv.innerHTML = `
                    <div class="col-span-16">
                        <h3 class="text-lg font-semibold mb-2 text-pink-600">ไม่พบข้อมูลตามเงื่อนไขที่เลือก</h3>
                        <p class="text-pink-500">ลองเปลี่ยนตัวกรองหรือเพิ่มงานใหม่</p>
                    </div>
                `;
                ganttBody.appendChild(noDataDiv);
                return;
            }

            filteredTasks.forEach((task, index) => {
                try {
                    const row = document.createElement('div');
                    row.className = 'grid grid-cols-16 gap-2 mb-2 items-center';
                    
                    const taskInfo = document.createElement('div');
                    taskInfo.className = 'col-span-4 bg-white border border-pink-200 p-3 rounded shadow-sm hover:shadow-md transition-shadow';
                    
                    const daysLeft = calculateDaysLeft(task.endDate);
                    const daysLeftText = daysLeft < 0 ? 'เกินกำหนด' : `${daysLeft} วัน`;
                    const daysLeftClass = daysLeft < 0 ? 'text-red-600 font-bold' : daysLeft < 7 ? 'text-yellow-600 font-bold' : 'text-gray-600';
                    
                    taskInfo.innerHTML = `
                        <div class="flex items-center mb-2">
                            ${task.image ? `<img src="${task.image}" alt="${task.responsible}" class="w-8 h-8 rounded-full object-cover mr-2" onerror="this.style.display='none';">` : '<div class="w-8 h-8 rounded-full bg-pink-200 flex items-center justify-center mr-2"><i class="fas fa-user text-pink-500 text-xs"></i></div>'}
                            <div class="font-semibold text-sm text-pink-800">${task.taskName || 'ไม่ระบุชื่องาน'}</div>
                        </div>
                        <div class="text-xs text-gray-600 mb-1">👤 ${task.responsible || 'ไม่ระบุ'}</div>
                        <div class="text-xs text-gray-600 mb-1">🏢 ${task.position || 'ไม่ระบุตำแหน่ง'}</div>
                        <div class="text-xs text-gray-600 mb-1">📅 ${formatDate(task.startDate)} - ${formatDate(task.endDate)}</div>
                        <div class="text-xs ${daysLeftClass} mb-2">⏰ ${daysLeftText}</div>
                        <div class="flex items-center justify-between">
                            <span class="px-2 py-1 rounded-full text-xs ${getStatusClass(task.status)}">${task.status}</span>
                            <button onclick="showTaskDetails(${JSON.stringify(task).replace(/"/g, '&quot;')})" class="text-pink-500 hover:text-pink-700 text-xs" title="ดูรายละเอียด">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </div>
                    `;

                    const timeline = document.createElement('div');
                    timeline.className = 'col-span-12 grid grid-cols-12 gap-2';

                    // Calculate which months the task spans
                    const startDate = new Date(task.startDate);
                    const endDate = new Date(task.endDate);
                    const months = getMonthsSpanned(startDate, endDate);

                    for (let month = 1; month <= 12; month++) {
                        const monthDiv = document.createElement('div');
                        monthDiv.className = 'h-8 bg-gray-100 rounded relative border border-gray-200';

                        if (months.includes(month)) {
                            const bar = document.createElement('div');
                            bar.className = `gantt-bar ${getGanttStatusClass(task.status)} cursor-pointer transition-all hover:opacity-80 hover:scale-105`;
                            bar.style.width = '100%';
                            bar.title = `${task.taskName} - ${task.status}\nผู้รับผิดชอบ: ${task.responsible}\nคลิกเพื่อดูรายละเอียด`;
                            bar.onclick = () => showTaskDetails(task);
                            
                            // Add progress indicator
                            const progressText = document.createElement('div');
                            progressText.className = 'absolute inset-0 flex items-center justify-center text-white text-xs font-semibold drop-shadow';
                            progressText.textContent = task.status === 'เสร็จสมบูรณ์' ? '✓' : 
                                                    task.status === 'กำลังดำเนินการ' ? '●' : 
                                                    task.status === 'ติดปัญหา/ล่าช้า' ? '!' : '○';
                            bar.appendChild(progressText);
                            
                            monthDiv.appendChild(bar);
                        }

                        timeline.appendChild(monthDiv);
                    }

                    row.appendChild(taskInfo);
                    row.appendChild(timeline);
                    ganttBody.appendChild(row);
                } catch (error) {
                    console.error('Error creating Gantt row for task:', task, error);
                }
            });
        }
        
        // Update Gantt filters
        function updateGanttFilters() {
            const responsibleFilter = document.getElementById('responsibleFilter');
            if (!responsibleFilter) return;
            
            // Clear existing options except "ทุกคน"
            responsibleFilter.innerHTML = '<option value="">ทุกคน</option>';
            
            // Add unique responsible persons from tasks
            const uniquePersons = [...new Set(tasks.map(t => t.responsible).filter(p => p))];
            uniquePersons.forEach(person => {
                const option = document.createElement('option');
                option.value = person;
                option.textContent = person;
                responsibleFilter.appendChild(option);
            });
        }
        
        // Get months spanned by a task
        function getMonthsSpanned(startDate, endDate) {
            const months = [];
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            // Get start and end months (1-12)
            const startMonth = start.getMonth() + 1;
            const endMonth = end.getMonth() + 1;
            const startYear = start.getFullYear();
            const endYear = end.getFullYear();
            
            if (startYear === endYear) {
                // Same year
                for (let month = startMonth; month <= endMonth; month++) {
                    months.push(month);
                }
            } else {
                // Different years - for now, show all months if spans multiple years
                // In a real application, you might want to handle this differently
                for (let month = startMonth; month <= 12; month++) {
                    months.push(month);
                }
                for (let month = 1; month <= endMonth; month++) {
                    months.push(month);
                }
            }
            
            return [...new Set(months)]; // Remove duplicates
        }

        // Update reports page
        function updateReportsPage() {
            populateReportFilters();
            updatePersonCards();
            updateReportTables();
        }

        // Populate filters
        function populateFilters() {
            populateReportFilters();
        }

        // Populate report filters
        function populateReportFilters() {
            const personFilter = document.getElementById('reportPersonFilter');
            const groupFilter = document.getElementById('reportGroupFilter');

            // Clear existing options
            personFilter.innerHTML = '<option value="">ทุกคน</option>';
            groupFilter.innerHTML = '<option value="">ทุกกลุ่ม</option>';

            // Add person options from actual task data
            const uniquePersons = [...new Set(tasks.map(t => t.responsible).filter(p => p))];
            uniquePersons.forEach(person => {
                const option = document.createElement('option');
                option.value = person;
                option.textContent = person;
                personFilter.appendChild(option);
            });

            // Add group options from actual task data
            const uniqueGroups = [...new Set(tasks.map(t => t.workGroup).filter(g => g))];
            uniqueGroups.forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                option.textContent = group;
                groupFilter.appendChild(option);
            });

            // Also populate responsible dropdown in task form
            const responsibleSelect = document.getElementById('responsible');
            if (responsibleSelect) {
                // Keep existing options and add new ones from tasks
                const existingOptions = Array.from(responsibleSelect.options).map(opt => opt.value);
                
                uniquePersons.forEach(person => {
                    if (!existingOptions.includes(person)) {
                        const option = document.createElement('option');
                        option.value = person;
                        option.textContent = person;
                        responsibleSelect.insertBefore(option, responsibleSelect.lastElementChild);
                    }
                });
            }
        }

        // Update person cards
        function updatePersonCards() {
            const container = document.getElementById('personCards');
            container.innerHTML = '';

            const staffData = getUniqueStaffData();
            
            if (staffData.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-gray-400 mb-4">
                            <i class="fas fa-users text-6xl"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">ยังไม่มีข้อมูลบุคลากร</h3>
                        <p class="text-gray-500">กรุณาเพิ่มงานใหม่เพื่อดูข้อมูลบุคลากร</p>
                    </div>
                `;
                return;
            }

            staffData.forEach(staff => {
                const staffTasks = tasks.filter(t => t.responsible === staff.name);
                const totalTasks = staffTasks.length;
                const inProgress = staffTasks.filter(t => t.status === 'กำลังดำเนินการ').length;
                const completed = staffTasks.filter(t => t.status === 'เสร็จสมบูรณ์').length;
                const delayed = staffTasks.filter(t => t.status === 'ติดปัญหา/ล่าช้า').length;
                const notStarted = staffTasks.filter(t => t.status === 'ยังไม่เริ่ม').length;

                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md p-6';
                card.innerHTML = `
                    <div class="flex items-center mb-4">
                        ${staff.image ? 
                            `<img src="${staff.image}" alt="${staff.name}" class="w-16 h-16 rounded-full object-cover mr-4" onerror="this.style.display='none';">` : 
                            '<div class="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center mr-4"><i class="fas fa-user text-gray-400 text-2xl"></i></div>'
                        }
                        <div>
                            <h3 class="font-semibold text-lg">${staff.name}</h3>
                            <p class="text-gray-600 text-sm">${staff.position}</p>
                            <p class="text-gray-500 text-xs">${staff.workGroup}</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600">${totalTasks}</div>
                            <div class="text-xs text-gray-600">งานทั้งหมด</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600">${completed}</div>
                            <div class="text-xs text-gray-600">เสร็จสมบูรณ์</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-yellow-600">${inProgress}</div>
                            <div class="text-xs text-gray-600">กำลังดำเนินการ</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-red-600">${delayed}</div>
                            <div class="text-xs text-gray-600">ล่าช้า</div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Update report tables
        function updateReportTables() {
            const pendingBody = document.getElementById('reportPendingBody');
            const completedBody = document.getElementById('reportCompletedBody');

            pendingBody.innerHTML = '';
            completedBody.innerHTML = '';

            const pendingTasks = tasks.filter(t => t.status !== 'เสร็จสมบูรณ์');
            const completedTasks = tasks.filter(t => t.status === 'เสร็จสมบูรณ์');

            pendingTasks.forEach(task => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-3">${task.taskName}</td>
                    <td class="px-4 py-3">${task.responsible}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded-full text-sm ${getStatusClass(task.status)}">${task.status}</span>
                    </td>
                    <td class="px-4 py-3">${formatDate(task.endDate)}</td>
                `;
                pendingBody.appendChild(row);
            });

            completedTasks.forEach(task => {
                const duration = calculateDuration(task.startDate, task.endDate);
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-3">${task.taskName}</td>
                    <td class="px-4 py-3">${task.responsible}</td>
                    <td class="px-4 py-3">${formatDate(task.endDate)}</td>
                    <td class="px-4 py-3">${duration} วัน</td>
                `;
                completedBody.appendChild(row);
            });
        }

        // Filter functions
        function filterGantt() {
            updateGanttChart();
        }

        function filterReports() {
            const personFilter = document.getElementById('reportPersonFilter');
            const groupFilter = document.getElementById('reportGroupFilter');
            
            let filteredTasks = [...tasks];
            
            // Filter by person
            if (personFilter && personFilter.value) {
                filteredTasks = filteredTasks.filter(task => task.responsible === personFilter.value);
            }
            
            // Filter by group
            if (groupFilter && groupFilter.value) {
                filteredTasks = filteredTasks.filter(task => task.workGroup === groupFilter.value);
            }
            
            // Update person cards with filtered data
            updatePersonCardsWithFilter(filteredTasks);
            updateReportTablesWithFilter(filteredTasks);
        }

        // Update person cards with filtered data
        function updatePersonCardsWithFilter(filteredTasks) {
            const container = document.getElementById('personCards');
            if (!container) return;
            
            container.innerHTML = '';

            const staffData = getUniqueStaffDataFromTasks(filteredTasks);
            
            if (staffData.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-gray-400 mb-4">
                            <i class="fas fa-users text-6xl"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">ไม่พบข้อมูลตามเงื่อนไขที่เลือก</h3>
                        <p class="text-gray-500">ลองเปลี่ยนตัวกรองหรือเพิ่มงานใหม่</p>
                    </div>
                `;
                return;
            }

            staffData.forEach(staff => {
                const staffTasks = filteredTasks.filter(t => t.responsible === staff.name);
                const totalTasks = staffTasks.length;
                const inProgress = staffTasks.filter(t => t.status === 'กำลังดำเนินการ').length;
                const completed = staffTasks.filter(t => t.status === 'เสร็จสมบูรณ์').length;
                const delayed = staffTasks.filter(t => t.status === 'ติดปัญหา/ล่าช้า').length;

                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow';
                card.innerHTML = `
                    <div class="flex items-center mb-4">
                        ${staff.image ? 
                            `<img src="${staff.image}" alt="${staff.name}" class="w-16 h-16 rounded-full object-cover mr-4" onerror="this.style.display='none';">` : 
                            '<div class="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center mr-4"><i class="fas fa-user text-gray-400 text-2xl"></i></div>'
                        }
                        <div>
                            <h3 class="font-semibold text-lg">${staff.name}</h3>
                            <p class="text-gray-600 text-sm">${staff.position}</p>
                            <p class="text-gray-500 text-xs">${staff.workGroup}</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600">${totalTasks}</div>
                            <div class="text-xs text-gray-600">งานทั้งหมด</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600">${completed}</div>
                            <div class="text-xs text-gray-600">เสร็จสมบูรณ์</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-yellow-600">${inProgress}</div>
                            <div class="text-xs text-gray-600">กำลังดำเนินการ</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-red-600">${delayed}</div>
                            <div class="text-xs text-gray-600">ล่าช้า</div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Update report tables with filtered data
        function updateReportTablesWithFilter(filteredTasks) {
            const pendingBody = document.getElementById('reportPendingBody');
            const completedBody = document.getElementById('reportCompletedBody');

            if (!pendingBody || !completedBody) return;

            pendingBody.innerHTML = '';
            completedBody.innerHTML = '';

            const pendingTasks = filteredTasks.filter(t => t.status !== 'เสร็จสมบูรณ์');
            const completedTasks = filteredTasks.filter(t => t.status === 'เสร็จสมบูรณ์');

            // Pending tasks
            if (pendingTasks.length === 0) {
                pendingBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                            ไม่มีงานที่ต้องจัดการตามเงื่อนไขที่เลือก
                        </td>
                    </tr>
                `;
            } else {
                pendingTasks.forEach(task => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-4 py-3">${task.taskName}</td>
                        <td class="px-4 py-3">${task.responsible}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 rounded-full text-sm ${getStatusClass(task.status)}">${task.status}</span>
                        </td>
                        <td class="px-4 py-3">${formatDate(task.endDate)}</td>
                    `;
                    pendingBody.appendChild(row);
                });
            }

            // Completed tasks
            if (completedTasks.length === 0) {
                completedBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                            ไม่มีงานที่เสร็จสิ้นตามเงื่อนไขที่เลือก
                        </td>
                    </tr>
                `;
            } else {
                completedTasks.forEach(task => {
                    const duration = calculateDuration(task.startDate, task.endDate);
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-4 py-3">${task.taskName}</td>
                        <td class="px-4 py-3">${task.responsible}</td>
                        <td class="px-4 py-3">${formatDate(task.endDate)}</td>
                        <td class="px-4 py-3">${duration} วัน</td>
                    `;
                    completedBody.appendChild(row);
                });
            }
        }

        // Get unique staff data from specific tasks
        function getUniqueStaffDataFromTasks(taskList) {
            const uniqueStaff = [];
            const seenNames = new Set();
            
            taskList.forEach(task => {
                if (task.responsible && !seenNames.has(task.responsible)) {
                    seenNames.add(task.responsible);
                    uniqueStaff.push({
                        name: task.responsible,
                        image: task.image || '',
                        position: task.position || '',
                        workGroup: task.workGroup || ''
                    });
                }
            });
            
            return uniqueStaff;
        }

        // Print report
        function printReport() {
            // Create a new window for printing
            const printWindow = window.open('', '_blank');
            
            // Get current filter values
            const personFilter = document.getElementById('reportPersonFilter');
            const groupFilter = document.getElementById('reportGroupFilter');
            const selectedPerson = personFilter ? personFilter.value : '';
            const selectedGroup = groupFilter ? groupFilter.value : '';
            
            // Filter tasks based on current selection
            let filteredTasks = [...tasks];
            if (selectedPerson) {
                filteredTasks = filteredTasks.filter(task => task.responsible === selectedPerson);
            }
            if (selectedGroup) {
                filteredTasks = filteredTasks.filter(task => task.workGroup === selectedGroup);
            }
            
            const pendingTasks = filteredTasks.filter(t => t.status !== 'เสร็จสมบูรณ์');
            const completedTasks = filteredTasks.filter(t => t.status === 'เสร็จสมบูรณ์');
            const staffData = getUniqueStaffDataFromTasks(filteredTasks);
            
            // Generate print content
            const printContent = `
                <!DOCTYPE html>
                <html lang="th">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>รายงานสรุปผลงานรายบุคคล</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
                        body { 
                            font-family: 'Sarabun', sans-serif; 
                            margin: 20px;
                            color: #333;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 2px solid #3b82f6;
                            padding-bottom: 20px;
                        }
                        .header h1 {
                            color: #3b82f6;
                            margin: 0;
                            font-size: 24px;
                        }
                        .header p {
                            margin: 5px 0;
                            color: #666;
                        }
                        .summary {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 20px;
                            margin-bottom: 30px;
                        }
                        .summary-card {
                            border: 1px solid #e5e7eb;
                            border-radius: 8px;
                            padding: 15px;
                            text-align: center;
                        }
                        .summary-card h3 {
                            margin: 0 0 10px 0;
                            color: #374151;
                        }
                        .summary-card .number {
                            font-size: 32px;
                            font-weight: bold;
                            margin: 10px 0;
                        }
                        .blue { color: #3b82f6; }
                        .green { color: #10b981; }
                        .yellow { color: #f59e0b; }
                        .red { color: #ef4444; }
                        .section {
                            margin-bottom: 30px;
                        }
                        .section h2 {
                            color: #374151;
                            border-bottom: 1px solid #e5e7eb;
                            padding-bottom: 10px;
                            margin-bottom: 15px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 20px;
                        }
                        th, td {
                            border: 1px solid #e5e7eb;
                            padding: 8px 12px;
                            text-align: left;
                        }
                        th {
                            background-color: #f9fafb;
                            font-weight: 600;
                        }
                        .status-badge {
                            padding: 4px 8px;
                            border-radius: 12px;
                            font-size: 12px;
                            font-weight: 500;
                        }
                        .status-completed { background-color: #d1fae5; color: #065f46; }
                        .status-progress { background-color: #dbeafe; color: #1e40af; }
                        .status-delayed { background-color: #fef3c7; color: #92400e; }
                        .status-notstarted { background-color: #fee2e2; color: #991b1b; }
                        .staff-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                            gap: 15px;
                            margin-bottom: 20px;
                        }
                        .staff-card {
                            border: 1px solid #e5e7eb;
                            border-radius: 8px;
                            padding: 15px;
                        }
                        .staff-card h4 {
                            margin: 0 0 5px 0;
                            color: #374151;
                        }
                        .staff-card p {
                            margin: 2px 0;
                            font-size: 14px;
                            color: #6b7280;
                        }
                        .staff-stats {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 10px;
                            margin-top: 10px;
                        }
                        .staff-stat {
                            text-align: center;
                            padding: 5px;
                        }
                        .staff-stat .number {
                            font-size: 18px;
                            font-weight: bold;
                        }
                        .staff-stat .label {
                            font-size: 11px;
                            color: #6b7280;
                        }
                        @media print {
                            body { margin: 0; }
                            .section { page-break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>รายงานสรุปผลงานรายบุคคล</h1>
                        <p>สำนักวิชาการ วิทยาเขตขอนแก่น</p>
                        <p>วันที่พิมพ์: ${new Date().toLocaleDateString('th-TH', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        })}</p>
                        ${selectedPerson ? `<p>ผู้รับผิดชอบ: ${selectedPerson}</p>` : ''}
                        ${selectedGroup ? `<p>กลุ่มงาน: ${selectedGroup}</p>` : ''}
                    </div>

                    <div class="summary">
                        <div class="summary-card">
                            <h3>งานทั้งหมด</h3>
                            <div class="number blue">${filteredTasks.length}</div>
                        </div>
                        <div class="summary-card">
                            <h3>เสร็จสมบูรณ์</h3>
                            <div class="number green">${completedTasks.length}</div>
                        </div>
                        <div class="summary-card">
                            <h3>กำลังดำเนินการ</h3>
                            <div class="number yellow">${filteredTasks.filter(t => t.status === 'กำลังดำเนินการ').length}</div>
                        </div>
                        <div class="summary-card">
                            <h3>ล่าช้า</h3>
                            <div class="number red">${filteredTasks.filter(t => t.status === 'ติดปัญหา/ล่าช้า').length}</div>
                        </div>
                    </div>

                    <div class="section">
                        <h2>สรุปรายบุคคล</h2>
                        <div class="staff-grid">
                            ${staffData.map(staff => {
                                const staffTasks = filteredTasks.filter(t => t.responsible === staff.name);
                                const totalTasks = staffTasks.length;
                                const inProgress = staffTasks.filter(t => t.status === 'กำลังดำเนินการ').length;
                                const completed = staffTasks.filter(t => t.status === 'เสร็จสมบูรณ์').length;
                                const delayed = staffTasks.filter(t => t.status === 'ติดปัญหา/ล่าช้า').length;
                                
                                return `
                                    <div class="staff-card">
                                        <h4>${staff.name}</h4>
                                        <p>${staff.position}</p>
                                        <p>${staff.workGroup}</p>
                                        <div class="staff-stats">
                                            <div class="staff-stat">
                                                <div class="number blue">${totalTasks}</div>
                                                <div class="label">งานทั้งหมด</div>
                                            </div>
                                            <div class="staff-stat">
                                                <div class="number green">${completed}</div>
                                                <div class="label">เสร็จสมบูรณ์</div>
                                            </div>
                                            <div class="staff-stat">
                                                <div class="number yellow">${inProgress}</div>
                                                <div class="label">กำลังดำเนินการ</div>
                                            </div>
                                            <div class="staff-stat">
                                                <div class="number red">${delayed}</div>
                                                <div class="label">ล่าช้า</div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <div class="section">
                        <h2>งานที่ต้องจัดการ (${pendingTasks.length} งาน)</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>ชื่องาน</th>
                                    <th>ผู้รับผิดชอบ</th>
                                    <th>สถานะ</th>
                                    <th>วันสิ้นสุด</th>
                                    <th>วันคงเหลือ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${pendingTasks.map(task => {
                                    const daysLeft = calculateDaysLeft(task.endDate);
                                    const statusClass = task.status === 'เสร็จสมบูรณ์' ? 'status-completed' :
                                                      task.status === 'กำลังดำเนินการ' ? 'status-progress' :
                                                      task.status === 'ติดปัญหา/ล่าช้า' ? 'status-delayed' : 'status-notstarted';
                                    
                                    return `
                                        <tr>
                                            <td>${task.taskName}</td>
                                            <td>${task.responsible}</td>
                                            <td><span class="status-badge ${statusClass}">${task.status}</span></td>
                                            <td>${formatDate(task.endDate)}</td>
                                            <td style="color: ${daysLeft < 0 ? '#ef4444' : daysLeft < 7 ? '#f59e0b' : '#374151'}; font-weight: ${daysLeft < 7 ? 'bold' : 'normal'}">
                                                ${daysLeft < 0 ? 'เกินกำหนด' : daysLeft + ' วัน'}
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="section">
                        <h2>งานที่เสร็จสิ้น (${completedTasks.length} งาน)</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>ชื่องาน</th>
                                    <th>ผู้รับผิดชอบ</th>
                                    <th>วันที่เสร็จ</th>
                                    <th>ระยะเวลาที่ใช้</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${completedTasks.map(task => {
                                    const duration = calculateDuration(task.startDate, task.endDate);
                                    return `
                                        <tr>
                                            <td>${task.taskName}</td>
                                            <td>${task.responsible}</td>
                                            <td>${formatDate(task.endDate)}</td>
                                            <td>${duration} วัน</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            // Wait for content to load then print
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 500);
            };
        }

        // Utility functions
        function calculateDaysLeft(endDate) {
            const today = new Date();
            const end = new Date(endDate);
            const diffTime = end - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        function calculateDuration(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = end - start;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH');
        }

        function getPriorityClass(priority) {
            switch (priority) {
                case 'สำคัญและเร่งด่วน': return 'priority-urgent';
                case 'สำคัญแต่ไม่เร่งด่วน': return 'priority-important';
                case 'ไม่สำคัญแต่เร่งด่วน': return 'priority-normal';
                case 'ไม่สำคัญและไม่เร่งด่วน': return 'priority-low';
                default: return 'priority-low';
            }
        }

        function getStatusClass(status) {
            switch (status) {
                case 'เสร็จสมบูรณ์': return 'bg-green-100 text-green-800';
                case 'กำลังดำเนินการ': return 'bg-blue-100 text-blue-800';
                case 'ติดปัญหา/ล่าช้า': return 'bg-yellow-100 text-yellow-800';
                case 'ยังไม่เริ่ม': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getGanttStatusClass(status) {
            switch (status) {
                case 'เสร็จสมบูรณ์': return 'gantt-complete';
                case 'กำลังดำเนินการ': return 'gantt-progress';
                case 'ติดปัญหา/ล่าช้า': return 'gantt-delayed';
                case 'ยังไม่เริ่ม': return 'gantt-notstarted';
                default: return 'gantt-notstarted';
            }
        }

        function getQuartersSpanned(startDate, endDate) {
            const quarters = [];
            const start = new Date(startDate);
            const end = new Date(endDate);

            // Q1: Jan-Mar, Q2: Apr-Jun, Q3: Jul-Sep, Q4: Oct-Dec
            const startQuarter = Math.floor(start.getMonth() / 3) + 1;
            const endQuarter = Math.floor(end.getMonth() / 3) + 1;

            for (let q = startQuarter; q <= endQuarter; q++) {
                quarters.push(q);
            }

            return quarters;
        }

        function showTaskDetails(task) {
            const daysLeft = calculateDaysLeft(task.endDate);
            const daysLeftText = daysLeft < 0 ? 'เกินกำหนดแล้ว' : `เหลืออีก ${daysLeft} วัน`;
            const duration = calculateDuration(task.startDate, task.endDate);
            
            Swal.fire({
                title: task.taskName || 'ไม่ระบุชื่องาน',
                html: `
                    <div class="text-left space-y-3">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-user text-blue-500"></i>
                            <span><strong>ผู้รับผิดชอบ:</strong> ${task.responsible || 'ไม่ระบุ'}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-briefcase text-green-500"></i>
                            <span><strong>ตำแหน่ง:</strong> ${task.position || 'ไม่ระบุ'}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-users text-purple-500"></i>
                            <span><strong>กลุ่มงาน:</strong> ${task.workGroup || 'ไม่ระบุ'}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-flag text-orange-500"></i>
                            <span><strong>ความสำคัญ:</strong> ${task.priority || 'ไม่ระบุ'}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-info-circle text-indigo-500"></i>
                            <span><strong>สถานะ:</strong> <span class="px-2 py-1 rounded-full text-sm ${getStatusClass(task.status)}">${task.status || 'ไม่ระบุ'}</span></span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-calendar-alt text-blue-500"></i>
                            <span><strong>วันเริ่มต้น:</strong> ${formatDate(task.startDate)}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-calendar-check text-red-500"></i>
                            <span><strong>วันสิ้นสุด:</strong> ${formatDate(task.endDate)}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-clock text-yellow-500"></i>
                            <span><strong>ระยะเวลา:</strong> ${duration} วัน</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-hourglass-half text-gray-500"></i>
                            <span><strong>เวลาคงเหลือ:</strong> <span class="${daysLeft < 0 ? 'text-red-600 font-bold' : daysLeft < 7 ? 'text-yellow-600 font-bold' : 'text-gray-600'}">${daysLeftText}</span></span>
                        </div>
                        ${task.taskDetail ? `
                        <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-start space-x-2">
                                <i class="fas fa-file-alt text-gray-500 mt-1"></i>
                                <div>
                                    <strong>รายละเอียดงาน:</strong>
                                    <p class="mt-1 text-gray-700">${task.taskDetail}</p>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `,
                width: '600px',
                confirmButtonText: 'ปิด',
                confirmButtonColor: '#3b82f6',
                customClass: {
                    popup: 'text-sm'
                }
            });
        }

        // Edit task function
        function editTask(taskId) {
            if (!isAdmin) {
                Swal.fire({
                    icon: 'error',
                    title: 'ไม่มีสิทธิ์เข้าถึง',
                    text: 'คุณไม่มีสิทธิ์ในการแก้ไขงาน',
                    confirmButtonText: 'ตกลง'
                });
                return;
            }

            console.log('Editing task with ID:', taskId, 'Type:', typeof taskId);
            console.log('Available tasks:', tasks.map(t => ({ id: t.id, type: typeof t.id, name: t.taskName })));

            // Find task with flexible ID matching
            let task = null;
            
            // Try exact match first
            task = tasks.find(t => t.id === taskId);
            
            // If not found, try string/number conversion
            if (!task) {
                const stringId = String(taskId);
                const numberId = Number(taskId);
                
                task = tasks.find(t => 
                    String(t.id) === stringId || 
                    Number(t.id) === numberId ||
                    t.id == taskId // Loose equality
                );
            }

            if (!task) {
                console.error('Task not found for ID:', taskId);
                Swal.fire({
                    icon: 'error',
                    title: 'ไม่พบงาน',
                    text: 'ไม่พบงานที่ต้องการแก้ไข',
                    confirmButtonText: 'ตกลง'
                });
                return;
            }

            console.log('Found task for editing:', task);

            // Set editing state
            editingTaskId = task.id;

            // Clear form first
            document.getElementById('taskForm').reset();
            clearImageSelection();
            
            // Hide custom fields initially
            document.getElementById('customResponsible').classList.add('hidden');
            document.getElementById('customPosition').classList.add('hidden');
            document.getElementById('customWorkGroup').classList.add('hidden');

            // Fill form with existing data
            if (task.image) {
                const dropZone = document.getElementById('imageDropZone');
                const dropZoneContent = document.getElementById('dropZoneContent');
                const preview = document.getElementById('imagePreview');
                
                // Update drop zone to show existing image
                dropZone.classList.remove('border-dashed', 'border-gray-300');
                dropZone.classList.add('border-solid', 'border-blue-400', 'bg-blue-50');
                
                dropZoneContent.innerHTML = `
                    <div class="flex items-center justify-center space-x-4">
                        <img src="${task.image}" alt="Preview" class="w-16 h-16 rounded-full object-cover border-2 border-blue-400">
                        <div class="text-left">
                            <p class="text-blue-700 font-semibold">✓ รูปภาพปัจจุบัน</p>
                            <p class="text-sm text-blue-600">คลิกเพื่อเปลี่ยนรูปใหม่</p>
                        </div>
                        <button type="button" onclick="clearImageSelection()" class="text-red-500 hover:text-red-700 transition-colors" title="ลบรูปภาพ">
                            <i class="fas fa-times-circle text-xl"></i>
                        </button>
                    </div>
                `;
                
                // Show preview
                preview.innerHTML = `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                        <div class="flex items-center space-x-4">
                            <img src="${task.image}" alt="Preview" class="w-20 h-20 rounded-lg object-cover border-2 border-gray-300">
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800 mb-1">รูปภาพปัจจุบัน</h4>
                                <div class="text-sm text-gray-600">
                                    <p><i class="fas fa-info-circle mr-2"></i>คลิกที่พื้นที่ด้านบนเพื่อเปลี่ยนรูปใหม่</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Fill basic fields
            document.getElementById('taskName').value = task.taskName || '';
            document.getElementById('taskDetail').value = task.taskDetail || '';
            document.getElementById('priority').value = task.priority || '';
            document.getElementById('status').value = task.status || '';
            document.getElementById('startDate').value = task.startDate || '';
            document.getElementById('endDate').value = task.endDate || '';
            
            // Set responsible person
            const responsibleSelect = document.getElementById('responsible');
            const responsibleOptions = Array.from(responsibleSelect.options).map(opt => opt.value);
            
            if (responsibleOptions.includes(task.responsible)) {
                responsibleSelect.value = task.responsible;
            } else if (task.responsible) {
                responsibleSelect.value = 'other';
                document.getElementById('customResponsible').value = task.responsible;
                document.getElementById('customResponsible').classList.remove('hidden');
            }
            
            // Set position
            const positionSelect = document.getElementById('position');
            const positionOptions = Array.from(positionSelect.options).map(opt => opt.value);
            
            if (positionOptions.includes(task.position)) {
                positionSelect.value = task.position;
            } else if (task.position) {
                positionSelect.value = 'other';
                document.getElementById('customPosition').value = task.position;
                document.getElementById('customPosition').classList.remove('hidden');
            }
            
            // Set work group
            const workGroupSelect = document.getElementById('workGroup');
            const workGroupOptions = Array.from(workGroupSelect.options).map(opt => opt.value);
            
            if (workGroupOptions.includes(task.workGroup)) {
                workGroupSelect.value = task.workGroup;
            } else if (task.workGroup) {
                workGroupSelect.value = 'other';
                document.getElementById('customWorkGroup').value = task.workGroup;
                document.getElementById('customWorkGroup').classList.remove('hidden');
            }
            
            // Change button text and modal title
            const saveButton = document.querySelector('#taskForm button[onclick="saveTask()"]');
            const modalTitle = document.querySelector('#taskModal h2');
            
            if (saveButton) {
                saveButton.innerHTML = '<i class="fas fa-save mr-2"></i>อัพเดทงาน';
            }
            if (modalTitle) {
                modalTitle.textContent = 'แก้ไขงาน';
            }
            
            openTaskModal();
        }

        // Delete task function
        async function deleteTask(taskId) {
            if (!isAdmin) {
                Swal.fire({
                    icon: 'error',
                    title: 'ไม่มีสิทธิ์เข้าถึง',
                    text: 'คุณไม่มีสิทธิ์ในการลบงาน',
                    confirmButtonText: 'ตกลง'
                });
                return;
            }

            console.log('Deleting task with ID:', taskId, 'Type:', typeof taskId);

            // Find task with flexible ID matching
            let task = null;
            let taskIndex = -1;
            
            // Try exact match first
            taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex !== -1) {
                task = tasks[taskIndex];
            }
            
            // If not found, try string/number conversion
            if (!task) {
                const stringId = String(taskId);
                const numberId = Number(taskId);
                
                taskIndex = tasks.findIndex(t => 
                    String(t.id) === stringId || 
                    Number(t.id) === numberId ||
                    t.id == taskId // Loose equality
                );
                
                if (taskIndex !== -1) {
                    task = tasks[taskIndex];
                }
            }

            if (!task || taskIndex === -1) {
                console.error('Task not found for deletion, ID:', taskId);
                Swal.fire({
                    icon: 'error',
                    title: 'ไม่พบงาน',
                    text: 'ไม่พบงานที่ต้องการลบ',
                    confirmButtonText: 'ตกลง'
                });
                return;
            }

            console.log('Found task for deletion:', task, 'at index:', taskIndex);

            // Show confirmation dialog
            const result = await Swal.fire({
                title: 'ยืนยันการลบงาน',
                html: `คุณแน่ใจหรือไม่ที่จะลบงาน<br><strong>"${task.taskName || 'ไม่ระบุชื่อ'}"</strong><br>ของ <strong>${task.responsible || 'ไม่ระบุผู้รับผิดชอบ'}</strong>?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'ลบงาน',
                cancelButtonText: 'ยกเลิก',
                reverseButtons: true
            });

            if (result.isConfirmed) {
                try {
                    console.log('Confirmed deletion, removing task...');
                    
                    // Remove from local array using index
                    const removedTask = tasks.splice(taskIndex, 1)[0];
                    console.log('Removed task:', removedTask);
                    console.log('Remaining tasks:', tasks.length);
                    
                    // Save to localStorage immediately
                    localStorage.setItem('tasks', JSON.stringify(tasks));
                    console.log('Saved to localStorage');
                    
                    // Try to remove from Firebase in background
                    if (firebaseInitialized && window.firebaseDB && removedTask.firebaseKey) {
                        try {
                            const taskRef = window.firebaseDB.ref(window.firebaseDB.database, `tasks/${removedTask.firebaseKey}`);
                            await window.firebaseDB.remove(taskRef);
                            console.log('Removed from Firebase');
                        } catch (firebaseError) {
                            console.warn('Firebase deletion failed:', firebaseError);
                        }
                    }
                    
                    // Refresh all views
                    refreshAllViews();
                    
                    // Show success message
                    Swal.fire({
                        icon: 'success',
                        title: 'ลบงานสำเร็จ!',
                        text: `ลบงาน "${removedTask.taskName}" เรียบร้อยแล้ว`,
                        timer: 2000,
                        showConfirmButton: false,
                        toast: true,
                        position: 'top-end'
                    });
                    
                } catch (error) {
                    console.error('Error deleting task:', error);
                    
                    // Restore from localStorage if something went wrong
                    try {
                        loadFromLocalStorage();
                        refreshAllViews();
                    } catch (restoreError) {
                        console.error('Error restoring data:', restoreError);
                    }
                    
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: 'ไม่สามารถลบงานได้ กรุณาลองใหม่อีกครั้ง',
                        confirmButtonText: 'ตกลง'
                    });
                }
            }
        }

        // Add real-time listener for Firebase changes
        function setupRealtimeListener() {
            if (!firebaseInitialized || !window.firebaseDB) {
                return;
            }

            const tasksRef = window.firebaseDB.ref(window.firebaseDB.database, 'tasks');
            window.firebaseDB.onValue(tasksRef, (snapshot) => {
                if (snapshot.exists()) {
                    const firebaseTasks = snapshot.val();
                    tasks = Object.keys(firebaseTasks).map(key => ({
                        ...firebaseTasks[key],
                        firebaseKey: key
                    }));
                    
                    // Update all views
                    updateDashboard();
                    updateTasksPage();
                    updateGanttChart();
                    updateReportsPage();
                }
            });
        }

        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing application...');
            
            try {
                // Load from localStorage immediately for better user experience
                loadFromLocalStorage();
                updateCurrentDate();
                
                // Set default dates
                const today = new Date().toISOString().split('T')[0];
                const nextWeek = new Date();
                nextWeek.setDate(nextWeek.getDate() + 7);
                
                const startDateInput = document.getElementById('startDate');
                const endDateInput = document.getElementById('endDate');
                
                if (startDateInput) {
                    startDateInput.value = today;
                }
                if (endDateInput) {
                    endDateInput.value = nextWeek.toISOString().split('T')[0];
                }
                
                // Initialize navigation - dashboard should be active by default
                const dashboardNav = document.getElementById('dashboardNav');
                if (dashboardNav) {
                    dashboardNav.classList.add('bg-blue-700');
                }
                
                // Show dashboard page
                showPage('dashboard');
                populateFilters();
                
                console.log('Application initialized successfully');
                
            } catch (error) {
                console.error('Error during initialization:', error);
                
                // Fallback initialization
                tasks = [];
                try {
                    updateDashboard();
                    updateTasksPage();
                    updateGanttChart();
                    updateReportsPage();
                } catch (updateError) {
                    console.error('Error in fallback updates:', updateError);
                }
            }
            
            // Fallback initialization if Firebase is not ready
            setTimeout(() => {
                if (!firebaseInitialized) {
                    console.log('Firebase not ready, using local data only');
                    firebaseInitialized = false; // Ensure we know Firebase is not available
                }
            }, 3000);
        });

        // Additional safety check for window load
        window.addEventListener('load', () => {
            console.log('Window loaded');
            
            // Ensure charts are properly initialized
            setTimeout(() => {
                try {
                    if (currentPage === 'dashboard') {
                        updateCharts();
                    }
                } catch (error) {
                    console.error('Error updating charts on window load:', error);
                }
            }, 1000);
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && currentPage) {
                // Refresh current page when tab becomes visible
                setTimeout(() => {
                    try {
                        updatePageContent(currentPage);
                    } catch (error) {
                        console.error('Error refreshing page on visibility change:', error);
                    }
                }, 500);
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'980a757dc0f3ee5a',t:'MTc1ODEzMTU2My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
